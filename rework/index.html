<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>Re-sewn Bags - Rework Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/recharts@2.10.1/umd/Recharts.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#030712;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;-webkit-tap-highlight-color:transparent}
    #root{min-height:100vh}
    select option{background:#1e293b;color:#f1f5f9}
    #loading-screen{position:fixed;inset:0;background:#030712;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
    #loading-screen .spinner{width:44px;height:44px;border:3px solid #1e293b;border-top-color:#3b82f6;border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    button{cursor:pointer;-webkit-appearance:none;touch-action:manipulation}
    select{-webkit-appearance:none;touch-action:manipulation}
    @media(max-width:600px){header{flex-wrap:wrap!important;gap:8px!important}}
  </style>
</head>
<body>
  <div id="loading-screen">
    <div class="spinner"></div>
    <div style="font-size:16px;font-weight:700;color:#f1f5f9">Loading Dashboard...</div>
    <div style="font-size:12px;color:#475569;margin-top:6px">Re-sewn Bags Rework Tracker</div>
  </div>
  <div id="root"></div>
  <script type="text/babel">

const { useState, useRef, useMemo, useCallback } = React;
const {
  Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend,
  ResponsiveContainer, ComposedChart, Cell, Line, ReferenceLine
} = Recharts;

// --- Icon shims (replaces Lucide) ---------------------------------------------
const Ic = ({ch, size=16, color="currentColor", style: extraStyle}) => (
  <span style={{fontSize:Math.round(size*0.85), color, display:"inline-flex",
    alignItems:"center", lineHeight:1, flexShrink:0, fontStyle:"normal", userSelect:"none",
    ...extraStyle}}>{ch}</span>
);
const Scissors      = (p) => <Ic ch="[/]" {...p}/>;
const Upload        = (p) => <Ic ch="^" {...p}/>;
const FileText      = (p) => <Ic ch="F" {...p}/>;
const TrendingUp    = (p) => <Ic ch="+" {...p}/>;
const AlertTriangle = (p) => <Ic ch="!" {...p}/>;
const Award         = (p) => <Ic ch="*" {...p}/>;
const Activity      = (p) => <Ic ch="~" {...p}/>;
const Download      = (p) => <Ic ch="v" {...p}/>;
const X             = (p) => <Ic ch="X" {...p}/>;
const Printer       = (p) => <Ic ch="P" {...p}/>;
const ChevronUp     = (p) => <Ic ch="^" {...p}/>;
const ChevronDown   = (p) => <Ic ch="v" {...p}/>;
const Package       = (p) => <Ic ch="[o]" {...p}/>;
const Cpu           = (p) => <Ic ch="#" {...p}/>;
const LayoutGrid    = (p) => <Ic ch="=" {...p}/>;
const CheckCircle   = (p) => <Ic ch="+" {...p}/>;
const RefreshCw     = (p) => <Ic ch="~" {...p}/>;
const Users         = (p) => <Ic ch="U" {...p}/>;
const Star          = (p) => <Ic ch="*" {...p}/>;
const ThumbsDown    = (p) => <Ic ch="-" {...p}/>;
const Calendar      = (p) => <Ic ch="D" {...p}/>;
const ChevronLeft   = (p) => <Ic ch="<" {...p}/>;
const ChevronRight  = (p) => <Ic ch=">" {...p}/>;

// --- DEFAULT DATA - Feb 2026 --------------------------------------------------
const DEFAULT_DAILY = [
  { date:"Feb 01", shiftDay:139, shiftNight:101, total:240 },
  { date:"Feb 02", shiftDay:97,  shiftNight:107, total:204 },
  { date:"Feb 03", shiftDay:93,  shiftNight:85,  total:178 },
  { date:"Feb 04", shiftDay:99,  shiftNight:91,  total:190 },
  { date:"Feb 05", shiftDay:93,  shiftNight:82,  total:175 },
  { date:"Feb 07", shiftDay:64,  shiftNight:97,  total:161 },
  { date:"Feb 08", shiftDay:51,  shiftNight:89,  total:140 },
  { date:"Feb 09", shiftDay:71,  shiftNight:82,  total:153 },
  { date:"Feb 10", shiftDay:136, shiftNight:83,  total:219 },
  { date:"Feb 11", shiftDay:109, shiftNight:96,  total:205 },
  { date:"Feb 12", shiftDay:109, shiftNight:93,  total:202 },
  { date:"Feb 14", shiftDay:137, shiftNight:95,  total:232 },
  { date:"Feb 15", shiftDay:88,  shiftNight:86,  total:174 },
  { date:"Feb 16", shiftDay:92,  shiftNight:94,  total:186 },
  { date:"Feb 17", shiftDay:79,  shiftNight:99,  total:178 },
  { date:"Feb 18", shiftDay:89,  shiftNight:87,  total:176 },
  { date:"Feb 19", shiftDay:86,  shiftNight:87,  total:173 },
  { date:"Feb 21", shiftDay:75,  shiftNight:77,  total:152 },
  { date:"Feb 22", shiftDay:90,  shiftNight:85,  total:175 },
  { date:"Feb 23", shiftDay:67,  shiftNight:83,  total:150 },
  { date:"Feb 24", shiftDay:65,  shiftNight:75,  total:140 },
];
const DEFAULT_MACHINE = [
  { machine:"MC-12", rework:180 }, { machine:"MC-18", rework:175 },
  { machine:"MC-07", rework:170 }, { machine:"MC-05", rework:168 },
  { machine:"MC-15", rework:167 }, { machine:"MC-28", rework:163 },
  { machine:"MC-16", rework:158 }, { machine:"MC-30", rework:156 },
  { machine:"MC-04", rework:154 }, { machine:"MC-27", rework:153 },
];
const DEFAULT_LINE = [
  { line:"Line 11", rework:366 }, { line:"Line 03", rework:341 },
  { line:"Line 10", rework:328 }, { line:"Line 06", rework:327 },
  { line:"Line 09", rework:310 }, { line:"Line 08", rework:309 },
  { line:"Line 12", rework:305 }, { line:"Line 07", rework:283 },
  { line:"Line 01", rework:279 }, { line:"Line 04", rework:261 },
  { line:"Line 02", rework:236 }, { line:"Line 05", rework:232 },
  { line:"Line 13", rework:226 },
];
// All 68 sewers sorted by total descending - Feb 2026
const DEFAULT_SEWER = [
  { id:"60033", top:0,  bottom:126, total:126 },
  { id:"50011", top:0,  bottom:111, total:111 },
  { id:"60031", top:0,  bottom:106, total:106 },
  { id:"7048",  top:0,  bottom:104, total:104 },
  { id:"7844",  top:0,  bottom:104, total:104 },
  { id:"3324",  top:102,bottom:0,   total:102 },
  { id:"60015", top:0,  bottom:98,  total:98  },
  { id:"7134",  top:0,  bottom:96,  total:96  },
  { id:"60042", top:0,  bottom:94,  total:94  },
  { id:"60021", top:93, bottom:0,   total:93  },
  { id:"60014", top:0,  bottom:93,  total:93  },
  { id:"7314",  top:4,  bottom:83,  total:87  },
  { id:"7145",  top:75, bottom:11,  total:86  },
  { id:"7633",  top:0,  bottom:83,  total:83  },
  { id:"7698",  top:76, bottom:4,   total:80  },
  { id:"7320",  top:0,  bottom:77,  total:77  },
  { id:"60064", top:0,  bottom:76,  total:76  },
  { id:"60007", top:74, bottom:0,   total:74  },
  { id:"3850",  top:0,  bottom:74,  total:74  },
  { id:"7826",  top:10, bottom:62,  total:72  },
  { id:"3139",  top:0,  bottom:69,  total:69  },
  { id:"2071",  top:0,  bottom:69,  total:69  },
  { id:"6130",  top:0,  bottom:68,  total:68  },
  { id:"50039", top:0,  bottom:68,  total:68  },
  { id:"2116",  top:67, bottom:0,   total:67  },
  { id:"2565",  top:66, bottom:0,   total:66  },
  { id:"60053", top:61, bottom:5,   total:66  },
  { id:"7128",  top:66, bottom:0,   total:66  },
  { id:"3079",  top:0,  bottom:66,  total:66  },
  { id:"2996",  top:0,  bottom:66,  total:66  },
  { id:"3880",  top:65, bottom:0,   total:65  },
  { id:"7071",  top:3,  bottom:62,  total:65  },
  { id:"60023", top:0,  bottom:64,  total:64  },
  { id:"7848",  top:0,  bottom:63,  total:63  },
  { id:"3326",  top:62, bottom:0,   total:62  },
  { id:"7331",  top:51, bottom:10,  total:61  },
  { id:"7681",  top:60, bottom:0,   total:60  },
  { id:"60035", top:0,  bottom:60,  total:60  },
  { id:"6112",  top:0,  bottom:57,  total:57  },
  { id:"3523",  top:55, bottom:0,   total:55  },
  { id:"5253",  top:54, bottom:0,   total:54  },
  { id:"7273",  top:0,  bottom:54,  total:54  },
  { id:"50012", top:53, bottom:0,   total:53  },
  { id:"60028", top:45, bottom:6,   total:51  },
  { id:"7270",  top:43, bottom:2,   total:45  },
  { id:"60066", top:45, bottom:0,   total:45  },
  { id:"60041", top:40, bottom:5,   total:45  },
  { id:"7263",  top:44, bottom:0,   total:44  },
  { id:"7367",  top:43, bottom:0,   total:43  },
  { id:"7631",  top:42, bottom:0,   total:42  },
  { id:"60034", top:39, bottom:0,   total:39  },
  { id:"60008", top:37, bottom:0,   total:37  },
  { id:"2534",  top:24, bottom:6,   total:30  },
  { id:"2523",  top:24, bottom:0,   total:24  },
  { id:"7827",  top:0,  bottom:16,  total:16  },
  { id:"3886",  top:0,  bottom:14,  total:14  },
  { id:"7894",  top:9,  bottom:0,   total:9   },
  { id:"7691",  top:6,  bottom:0,   total:6   },
  { id:"60069", top:0,  bottom:6,   total:6   },
  { id:"6007",  top:5,  bottom:0,   total:5   },
  { id:"60029", top:0,  bottom:5,   total:5   },
  { id:"3123",  top:3,  bottom:0,   total:3   },
  { id:"2895",  top:3,  bottom:0,   total:3   },
  { id:"2891",  top:3,  bottom:0,   total:3   },
  { id:"2984",  top:2,  bottom:0,   total:2   },
  { id:"2894",  top:2,  bottom:0,   total:2   },
  { id:"7337",  top:1,  bottom:0,   total:1   },
  { id:"60009", top:0,  bottom:0,   total:0   },
];

// --- PER-DAY SEWER / MACHINE / LINE DATA - Feb 2026 -------------------------
const DEFAULT_DAILY_SEWERS = {
  "Feb 01":{worst:[{id:"7048",total:17},{id:"6130",total:15},{id:"50011",total:14},{id:"60015",total:9},{id:"60007",total:8}],best:[{id:"6112",total:2},{id:"3079",total:2},{id:"60041",total:2},{id:"60066",total:2},{id:"5253",total:2}],worst_mc:[{machine:"MC-07",rework:23},{machine:"MC-13",rework:18},{machine:"MC-28",rework:16}],worst_line:[{line:"Line 03",rework:31},{line:"Line 09",rework:26},{line:"Line 01",rework:25}]},
  "Feb 02":{worst:[{id:"7048",total:8},{id:"60021",total:7},{id:"3324",total:7},{id:"7844",total:7},{id:"60042",total:7}],best:[{id:"3886",total:1},{id:"60053",total:1},{id:"7633",total:2},{id:"60023",total:2},{id:"7320",total:2}],worst_mc:[{machine:"MC-07",rework:13},{machine:"MC-13",rework:10},{machine:"MC-12",rework:10}],worst_line:[{line:"Line 03",rework:23},{line:"Line 01",rework:19},{line:"Line 04",rework:18}]},
  "Feb 03":{worst:[{id:"60021",total:8},{id:"3324",total:7},{id:"60015",total:7},{id:"60064",total:6},{id:"7270",total:5}],best:[{id:"2534",total:1},{id:"6112",total:2},{id:"60023",total:2},{id:"7320",total:2},{id:"3139",total:2}],worst_mc:[{machine:"MC-09",rework:11},{machine:"MC-15",rework:10},{machine:"MC-26",rework:10}],worst_line:[{line:"Line 08",rework:19},{line:"Line 10",rework:17},{line:"Line 11",rework:16}]},
  "Feb 04":{worst:[{id:"60021",total:11},{id:"7844",total:8},{id:"3324",total:7},{id:"60015",total:7},{id:"2534",total:6}],best:[{id:"60023",total:1},{id:"60053",total:1},{id:"60035",total:2},{id:"7134",total:2},{id:"6130",total:2}],worst_mc:[{machine:"MC-09",rework:12},{machine:"MC-15",rework:12},{machine:"MC-12",rework:12}],worst_line:[{line:"Line 03",rework:22},{line:"Line 13",rework:20},{line:"Line 08",rework:18}]},
  "Feb 05":{worst:[{id:"2534",total:10},{id:"7698",total:9},{id:"3324",total:8},{id:"7681",total:5},{id:"3523",total:5}],best:[{id:"2565",total:1},{id:"7270",total:1},{id:"60042",total:2},{id:"7633",total:2},{id:"2071",total:2}],worst_mc:[{machine:"MC-06",rework:16},{machine:"MC-26",rework:11},{machine:"MC-11",rework:10}],worst_line:[{line:"Line 10",rework:20},{line:"Line 01",rework:16},{line:"Line 06",rework:16}]},
  "Feb 07":{worst:[{id:"7848",total:8},{id:"3324",total:7},{id:"2071",total:7},{id:"60033",total:7},{id:"60021",total:6}],best:[{id:"60023",total:1},{id:"6130",total:1},{id:"60007",total:1},{id:"2565",total:1},{id:"7273",total:2}],worst_mc:[{machine:"MC-01",rework:9},{machine:"MC-26",rework:9},{machine:"MC-18",rework:9}],worst_line:[{line:"Line 11",rework:17},{line:"Line 10",rework:16},{line:"Line 05",rework:14}]},
  "Feb 08":{worst:[{id:"7145",total:9},{id:"3880",total:6},{id:"3324",total:5},{id:"50011",total:5},{id:"7844",total:5}],best:[{id:"60023",total:1},{id:"60014",total:1},{id:"7048",total:1},{id:"60053",total:1},{id:"7681",total:1}],worst_mc:[{machine:"MC-06",rework:12},{machine:"MC-16",rework:9},{machine:"MC-12",rework:9}],worst_line:[{line:"Line 10",rework:17},{line:"Line 11",rework:16},{line:"Line 05",rework:13}]},
  "Feb 09":{worst:[{id:"7698",total:12},{id:"60053",total:7},{id:"60042",total:6},{id:"7367",total:5},{id:"2996",total:5}],best:[{id:"7048",total:1},{id:"3139",total:1},{id:"60034",total:1},{id:"60008",total:1},{id:"7273",total:2}],worst_mc:[{machine:"MC-27",rework:16},{machine:"MC-12",rework:10},{machine:"MC-11",rework:9}],worst_line:[{line:"Line 07",rework:22},{line:"Line 05",rework:14},{line:"Line 10",rework:14}]},
  "Feb 10":{worst:[{id:"7134",total:12},{id:"60064",total:10},{id:"60015",total:9},{id:"7071",total:8},{id:"60007",total:8}],best:[{id:"2071",total:2},{id:"60028",total:2},{id:"60066",total:2},{id:"3324",total:2},{id:"7263",total:2}],worst_mc:[{machine:"MC-29",rework:16},{machine:"MC-16",rework:15},{machine:"MC-09",rework:14}],worst_line:[{line:"Line 08",rework:22},{line:"Line 10",rework:22},{line:"Line 11",rework:22}]},
  "Feb 11":{worst:[{id:"7134",total:9},{id:"50011",total:8},{id:"60064",total:8},{id:"60023",total:8},{id:"3326",total:7}],best:[{id:"2071",total:2},{id:"2996",total:2},{id:"3079",total:2},{id:"7048",total:2},{id:"60041",total:2}],worst_mc:[{machine:"MC-16",rework:13},{machine:"MC-09",rework:11},{machine:"MC-29",rework:11}],worst_line:[{line:"Line 09",rework:20},{line:"Line 10",rework:20},{line:"Line 12",rework:20}]},
  "Feb 12":{worst:[{id:"6112",total:9},{id:"7698",total:7},{id:"60041",total:7},{id:"50011",total:7},{id:"7134",total:7}],best:[{id:"7681",total:1},{id:"60023",total:2},{id:"3139",total:2},{id:"6130",total:2},{id:"60028",total:2}],worst_mc:[{machine:"MC-28",rework:13},{machine:"MC-27",rework:12},{machine:"MC-09",rework:12}],worst_line:[{line:"Line 04",rework:21},{line:"Line 09",rework:21},{line:"Line 08",rework:19}]},
  "Feb 14":{worst:[{id:"60033",total:16},{id:"7145",total:11},{id:"60015",total:9},{id:"50011",total:9},{id:"60035",total:8}],best:[{id:"60028",total:1},{id:"7270",total:1},{id:"7848",total:2},{id:"2996",total:2},{id:"6130",total:2}],worst_mc:[{machine:"MC-18",rework:19},{machine:"MC-09",rework:14},{machine:"MC-12",rework:12}],worst_line:[{line:"Line 11",rework:30},{line:"Line 04",rework:21},{line:"Line 06",rework:21}]},
  "Feb 15":{worst:[{id:"50011",total:13},{id:"6130",total:7},{id:"60033",total:7},{id:"7048",total:7},{id:"7273",total:6}],best:[{id:"7848",total:1},{id:"60028",total:1},{id:"7631",total:1},{id:"60034",total:1},{id:"2996",total:2}],worst_mc:[{machine:"MC-12",rework:16},{machine:"MC-28",rework:13},{machine:"MC-07",rework:12}],worst_line:[{line:"Line 03",rework:19},{line:"Line 01",rework:18},{line:"Line 10",rework:17}]},
  "Feb 16":{worst:[{id:"7314",total:17},{id:"7145",total:8},{id:"3850",total:8},{id:"7071",total:8},{id:"7844",total:6}],best:[{id:"6112",total:1},{id:"6130",total:1},{id:"2523",total:1},{id:"60041",total:1},{id:"60028",total:1}],worst_mc:[{machine:"MC-04",rework:22},{machine:"MC-10",rework:16},{machine:"MC-07",rework:10}],worst_line:[{line:"Line 08",rework:28},{line:"Line 06",rework:22},{line:"Line 03",rework:18}]},
  "Feb 17":{worst:[{id:"7128",total:16},{id:"60033",total:7},{id:"7071",total:6},{id:"7048",total:6},{id:"7844",total:5}],best:[{id:"60028",total:1},{id:"3880",total:1},{id:"7270",total:1},{id:"7263",total:1},{id:"2996",total:2}],worst_mc:[{machine:"MC-04",rework:18},{machine:"MC-18",rework:10},{machine:"MC-14",rework:9}],worst_line:[{line:"Line 08",rework:26},{line:"Line 11",rework:17},{line:"Line 03",rework:15}]},
  "Feb 18":{worst:[{id:"3850",total:16},{id:"7844",total:10},{id:"60033",total:8},{id:"60028",total:7},{id:"50011",total:6}],best:[{id:"7314",total:1},{id:"6112",total:1},{id:"3326",total:1},{id:"60041",total:1},{id:"7263",total:1}],worst_mc:[{machine:"MC-10",rework:19},{machine:"MC-12",rework:12},{machine:"MC-18",rework:10}],worst_line:[{line:"Line 06",rework:25},{line:"Line 11",rework:19},{line:"Line 03",rework:18}]},
  "Feb 19":{worst:[{id:"3850",total:17},{id:"60033",total:15},{id:"7633",total:9},{id:"7320",total:8},{id:"60021",total:6}],best:[{id:"3139",total:1},{id:"7273",total:1},{id:"7128",total:1},{id:"60008",total:1},{id:"7145",total:1}],worst_mc:[{machine:"MC-10",rework:18},{machine:"MC-18",rework:15},{machine:"MC-27",rework:12}],worst_line:[{line:"Line 06",rework:25},{line:"Line 11",rework:24},{line:"Line 07",rework:17}]},
  "Feb 21":{worst:[{id:"60015",total:8},{id:"60033",total:7},{id:"60021",total:6},{id:"60042",total:6},{id:"7128",total:5}],best:[{id:"6112",total:1},{id:"6130",total:1},{id:"7894",total:1},{id:"60028",total:1},{id:"7631",total:1}],worst_mc:[{machine:"MC-04",rework:10},{machine:"MC-18",rework:9},{machine:"MC-09",rework:8}],worst_line:[{line:"Line 11",rework:17},{line:"Line 08",rework:15},{line:"Line 13",rework:15}]},
  "Feb 22":{worst:[{id:"7145",total:12},{id:"7844",total:9},{id:"3850",total:9},{id:"60042",total:7},{id:"2116",total:5}],best:[{id:"7631",total:1},{id:"7367",total:1},{id:"2996",total:2},{id:"60015",total:2},{id:"60035",total:2}],worst_mc:[{machine:"MC-10",rework:21},{machine:"MC-12",rework:10},{machine:"MC-15",rework:10}],worst_line:[{line:"Line 06",rework:26},{line:"Line 03",rework:18},{line:"Line 12",rework:16}]},
  "Feb 23":{worst:[{id:"60033",total:9},{id:"7048",total:9},{id:"3850",total:8},{id:"60042",total:7},{id:"7071",total:6}],best:[{id:"7844",total:1},{id:"7337",total:1},{id:"7698",total:1},{id:"2565",total:1},{id:"7331",total:1}],worst_mc:[{machine:"MC-18",rework:11},{machine:"MC-07",rework:10},{machine:"MC-30",rework:10}],worst_line:[{line:"Line 11",rework:20},{line:"Line 13",rework:18},{line:"Line 06",rework:16}]},
  "Feb 24":{worst:[{id:"7844",total:6},{id:"60033",total:6},{id:"60014",total:6},{id:"3850",total:5},{id:"60031",total:5}],best:[{id:"60023",total:1},{id:"6112",total:1},{id:"7894",total:1},{id:"3880",total:1},{id:"60008",total:1}],worst_mc:[{machine:"MC-12",rework:10},{machine:"MC-05",rework:10},{machine:"MC-18",rework:9}],worst_line:[{line:"Line 11",rework:19},{line:"Line 03",rework:17},{line:"Line 06",rework:12}]},
};

// --- EXCEL PARSER -------------------------------------------------------------
const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function excelSerialToDate(serial) {
  return new Date(Math.round((serial - 25569) * 86400 * 1000));
}
function formatDateKey(d) {
  return `${MONTHS[d.getMonth()]} ${String(d.getDate()).padStart(2,"0")}`;
}

function parseExcelWorkbook(workbook) {
  // Pick sheet: prefer one with "data" in name, else first sheet
  const sheetName = workbook.SheetNames.find(n => /data|base|sheet/i.test(n)) || workbook.SheetNames[0];
  const ws = workbook.Sheets[sheetName];
  if (!ws) return { _err: `No sheet found. Sheets: ${workbook.SheetNames.join(", ")}` };

  const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:"", raw:true });

  // Find header row - look up to row 15, accept date+shift OR date alone
  let headerIdx = -1;
  for (let i = 0; i < Math.min(rows.length, 15); i++) {
    const rowStr = rows[i].map(c => String(c).trim().toLowerCase());
    const hasDate  = rowStr.some(c => c === "date" || c === "تاريخ");
    const hasShift = rowStr.some(c => c.includes("shift") || c.includes("وردية") || c.includes("shift"));
    if (hasDate && hasShift) { headerIdx = i; break; }
    if (hasDate && rowStr.some(c => c.includes("line") || c.includes("mc") || c.includes("sewer"))) { headerIdx = i; break; }
  }
  if (headerIdx === -1) {
    const sample = rows.slice(0, 5).map(r => r.map(c => String(c).trim()).filter(Boolean).join(" | ")).join("\n");
    return { _err: `Could not find header row (need Date + Shift columns).\nSheet used: "${sheetName}"\nFirst rows:\n${sample}` };
  }

  const headers = rows[headerIdx].map(h => String(h).trim().toLowerCase());

  // Flexible column matching
  const find = (...terms) => headers.findIndex(h => terms.some(t => h.includes(t)));
  const idx = {
    date:          find("date", "تاريخ"),
    shift:         find("shift", "وردية", "vshift"),
    line:          find("line", "خط"),
    mc:            find("mc number", "mc no", "machine no", "ماكينة", "mc"),
    total:         find("total qty", "qty", "total", "كمية", "عدد"),
    topSewer:      find("top sewer", "sewer top", "خياط علوي", "top"),
    topRepaired:   find("total top", "top repaired", "top qty", "علوي"),
    bottomSewer:   find("bottom sewer", "sewer bottom", "خياط سفلي", "bottom"),
    bottomRepaired:find("total bottom", "bottom repaired", "bottom qty", "سفلي"),
  };
  // Fallback: if total not found use last col
  if (idx.total === -1) idx.total = headers.length - 1;

  if (idx.date === -1 || idx.shift === -1) {
    return { _err: `Missing required columns.\nSheet: "${sheetName}"\nHeaders found: ${headers.map((h,i)=>`[${i}]${h}`).join(", ")}\nNeed: Date, Shift` };
  }

  const records = [];
  for (let i = headerIdx + 1; i < rows.length; i++) {
    const row = rows[i];
    const rawDate  = row[idx.date];
    const rawShift = String(row[idx.shift] || "").trim();
    const rawQty   = parseInt(row[idx.total]) || 0;
    if (!rawDate || !rawShift || rawQty === 0) continue;

    let d;
    if (typeof rawDate === "number" && rawDate > 1000) d = excelSerialToDate(rawDate);
    else d = new Date(rawDate);
    if (isNaN(d.getTime())) continue;

    const dateKey      = formatDateKey(d);
    const shift        = rawShift.toLowerCase().includes("night") ? "Night" : "Day";
    const rawLine      = String(row[idx.line] || "").trim().replace(/\D/g,"");
    const line         = rawLine ? `Line ${rawLine.padStart(2,"0")}` : "Line -";
    const rawMc        = String(row[idx.mc]   || "").trim().replace(/\D/g,"");
    const mc           = rawMc   ? `MC-${rawMc.padStart(2,"0")}`   : "MC--";
    const topSewer     = String(row[idx.topSewer]      || "").trim();
    const topRepaired  = parseInt(row[idx.topRepaired])  || 0;
    const bottomSewer  = String(row[idx.bottomSewer]   || "").trim();
    const bottomRepaired = parseInt(row[idx.bottomRepaired]) || 0;

    records.push({ dateKey, dateObj:d, shift, line, mc, qty:rawQty,
                   topSewer, topRepaired, bottomSewer, bottomRepaired });
  }
  if (records.length === 0) {
    return { _err: `Parsed 0 records from sheet "${sheetName}".\nHeaders mapped: date[${idx.date}] shift[${idx.shift}] total[${idx.total}].\nCheck that rows have a Date, Shift, and non-zero quantity.` };
  }

  // Daily
  const dailyMap = {};
  records.forEach(({ dateKey, shift, qty }) => {
    if (!dailyMap[dateKey]) dailyMap[dateKey] = { date:dateKey, shiftDay:0, shiftNight:0, total:0 };
    if (shift === "Day") dailyMap[dateKey].shiftDay += qty;
    else dailyMap[dateKey].shiftNight += qty;
    dailyMap[dateKey].total += qty;
  });
  const dailyData = Object.values(dailyMap).sort((a,b) => {
    const [am,ad]=a.date.split(" "), [bm,bd]=b.date.split(" ");
    return new Date(2026,MONTHS.indexOf(am),parseInt(ad)) - new Date(2026,MONTHS.indexOf(bm),parseInt(bd));
  });

  // Machines
  const mcMap = {};
  records.forEach(({ mc, qty }) => { mcMap[mc] = (mcMap[mc]||0) + qty; });
  const machineData = Object.entries(mcMap).map(([machine,rework])=>({machine,rework}))
    .sort((a,b)=>b.rework-a.rework).slice(0,10);

  // Lines
  const lineMap = {};
  records.forEach(({ line, qty }) => { lineMap[line] = (lineMap[line]||0) + qty; });
  const lineData = Object.entries(lineMap).map(([line,rework])=>({line,rework}))
    .sort((a,b)=>b.rework-a.rework);

  // Sewers
  const sewerMap = {};
  records.forEach(({ topSewer, topRepaired, bottomSewer, bottomRepaired }) => {
    if (topSewer) {
      if (!sewerMap[topSewer]) sewerMap[topSewer] = { id:topSewer, top:0, bottom:0 };
      sewerMap[topSewer].top += topRepaired;
    }
    if (bottomSewer) {
      if (!sewerMap[bottomSewer]) sewerMap[bottomSewer] = { id:bottomSewer, top:0, bottom:0 };
      sewerMap[bottomSewer].bottom += bottomRepaired;
    }
  });
  const sewerData = Object.values(sewerMap)
    .map(s => ({ ...s, total: s.top + s.bottom }))
    .sort((a,b) => b.total - a.total);

  // Period
  const mons = [...new Set(records.map(r => MONTHS[r.dateObj.getMonth()]))];
  const year = records[0]?.dateObj.getFullYear() || new Date().getFullYear();
  const period = mons.length === 1 ? `${mons[0]} ${year}` : `${mons[0]}-${mons[mons.length-1]} ${year}`;

  // Per-day sewer + machine + line breakdown
  const dailySewerMap  = {}, dailyMcMap = {}, dailyLineMap = {};
  records.forEach(({ dateKey, topSewer, topRepaired, bottomSewer, bottomRepaired, mc, qty, line }) => {
    if (!dailySewerMap[dateKey])  dailySewerMap[dateKey]  = {};
    if (!dailyMcMap[dateKey])     dailyMcMap[dateKey]     = {};
    if (!dailyLineMap[dateKey])   dailyLineMap[dateKey]   = {};
    if (topSewer && topRepaired > 0) {
      if (!dailySewerMap[dateKey][topSewer]) dailySewerMap[dateKey][topSewer] = { id:topSewer, top:0, bottom:0 };
      dailySewerMap[dateKey][topSewer].top += topRepaired;
    }
    if (bottomSewer && bottomRepaired > 0) {
      if (!dailySewerMap[dateKey][bottomSewer]) dailySewerMap[dateKey][bottomSewer] = { id:bottomSewer, top:0, bottom:0 };
      dailySewerMap[dateKey][bottomSewer].bottom += bottomRepaired;
    }
    dailyMcMap[dateKey][mc]     = (dailyMcMap[dateKey][mc]   || 0) + qty;
    dailyLineMap[dateKey][line] = (dailyLineMap[dateKey][line] || 0) + qty;
  });
  const dailySewers = {};
  Object.keys(dailySewerMap).forEach(date => {
    const sorted = Object.values(dailySewerMap[date])
      .map(s => ({ ...s, total: s.top + s.bottom }))
      .sort((a,b) => b.total - a.total);
    dailySewers[date] = {
      worst: sorted.slice(0, 5),
      best:  sorted.filter(s => s.total > 0).slice(-5).reverse(),
      worst_mc:   Object.entries(dailyMcMap[date]||{}).map(([machine,rework])=>({machine,rework})).sort((a,b)=>b.rework-a.rework).slice(0,3),
      worst_line: Object.entries(dailyLineMap[date]||{}).map(([line,rework])=>({line,rework})).sort((a,b)=>b.rework-a.rework).slice(0,3),
    };
  });

  return { dailyData, machineData, lineData, sewerData, dailySewers, period, sheetName };
}

// --- COLORS ------------------------------------------------------------------
const C_DAY   = "#3B82F6";
const C_NIGHT = "#F59E0B";
const LINE_COLORS = ["#3B82F6","#10B981","#F59E0B","#EF4444","#8B5CF6",
                     "#14B8A6","#EC4899","#6366F1","#f97316","#84cc16","#06b6d4","#a78bfa","#fb7185"];

// --- TOOLTIP -----------------------------------------------------------------
const Tip = ({ active, payload, label }) => {
  if (!active || !payload?.length) return null;
  return (
    <div style={{ background:"#111827", border:"1px solid #374151", borderRadius:10, padding:"10px 14px", minWidth:140 }}>
      <p style={{ color:"#9ca3af", fontSize:11, marginBottom:5, fontWeight:600 }}>{label}</p>
      {payload.map((e,i)=>(
        <p key={i} style={{ color:e.color, fontSize:12, margin:"2px 0", display:"flex", justifyContent:"space-between", gap:14 }}>
          <span>{e.name}</span>
          <span style={{ fontWeight:700 }}>{typeof e.value==="number"&&e.value%1!==0?e.value.toFixed(1):e.value}</span>
        </p>
      ))}
    </div>
  );
};

// --- ROLE BADGE ---------------------------------------------------------------
function roleBadge(s) {
  const hasTop = s.top > 0, hasBot = s.bottom > 0;
  if (hasTop && hasBot) return { label:"T+B", color:"#8B5CF6" };
  if (hasTop)           return { label:"Top", color:"#3B82F6" };
  return                       { label:"Bot", color:"#F59E0B" };
}

// --- MAIN ---------------------------------------------------------------------
function Dashboard() {
  const [uploadedData, setUploadedData] = useState(null);
  const [fileName,     setFileName]     = useState(null);
  const [parseError,   setParseError]   = useState(null);
  const [dragging,     setDragging]     = useState(false);
  const [loading,      setLoading]      = useState(false);
  const [showUpload,   setShowUpload]   = useState(false);
  const [selIdx,       setSelIdx]       = useState(null); // null = last available date
  const [viewMode,     setViewMode]     = useState("month"); // "month" | "day"
  const [showDayModal, setShowDayModal] = useState(false);
  const fileRef = useRef(null);

  // Active full data
  const dailyData    = uploadedData?.dailyData    ?? DEFAULT_DAILY;
  const machineData  = uploadedData?.machineData  ?? DEFAULT_MACHINE;
  const lineData     = uploadedData?.lineData     ?? DEFAULT_LINE;
  const sewerData    = uploadedData?.sewerData    ?? DEFAULT_SEWER;
  const dailySewers  = uploadedData?.dailySewers  ?? DEFAULT_DAILY_SEWERS;
  const period       = uploadedData?.period       ?? "February 2026";
  const isDefault   = !uploadedData;

  // -- Selected date index (null -> last date) --------------------------------
  const effectiveIdx  = selIdx !== null ? selIdx : dailyData.length - 1;
  const clampedIdx    = Math.max(0, Math.min(effectiveIdx, dailyData.length - 1));
  const selectedDay   = dailyData[clampedIdx] || { total:0, shiftDay:0, shiftNight:0, date:"-" };
  const prevDay       = clampedIdx > 0 ? dailyData[clampedIdx - 1] : { total:0, date:"-" };
  const trend         = prevDay.total > 0
    ? ((selectedDay.total - prevDay.total) / prevDay.total * 100).toFixed(1) : "0.0";
  const isLastDate    = clampedIdx === dailyData.length - 1;

  // -- MTD data up to (and including) selected date --------------------------
  const mtdData    = useMemo(() => dailyData.slice(0, clampedIdx + 1), [dailyData, clampedIdx]);
  const grandTotal = useMemo(() => mtdData.reduce((s,d)=>s+d.total, 0), [mtdData]);
  const totalDay   = useMemo(() => mtdData.reduce((s,d)=>s+d.shiftDay, 0), [mtdData]);
  const totalNight = useMemo(() => mtdData.reduce((s,d)=>s+d.shiftNight, 0), [mtdData]);
  const avgDaily   = useMemo(() => (grandTotal / (mtdData.length||1)).toFixed(1), [grandTotal, mtdData]);
  const maxDay     = useMemo(() => mtdData.reduce((a,b)=>b.total>a.total?b:a, mtdData[0]||{total:0,date:"-"}), [mtdData]);
  const minDay     = useMemo(() => mtdData.reduce((a,b)=>b.total<a.total?b:a, mtdData[0]||{total:0,date:"-"}), [mtdData]);
  const bestShift  = totalDay < totalNight ? "Day Shift" : "Night Shift";
  const topMachine = machineData[0] || { machine:"-", rework:0 };

  // Period label for selected range
  const mtdPeriod = mtdData.length < dailyData.length && mtdData.length > 0
    ? `${dailyData[0]?.date} -> ${selectedDay.date}`
    : period;

  // Sewer charts
  const worstSewers = useMemo(() => sewerData.slice(0, 10), [sewerData]);
  const bestSewers  = useMemo(() => {
    const active = sewerData.filter(s => s.total >= 20);
    return active.slice(-10).reverse();
  }, [sewerData]);
  const worstSewer = sewerData[0] || { id:"-", total:0 };
  const bestSewer  = useMemo(() => {
    const active = sewerData.filter(s => s.total >= 20);
    return active[active.length - 1] || { id:"-", total:0 };
  }, [sewerData]);

  // File handler
  const handleFile = useCallback((file) => {
    if (!file) return;
    if (!file.name.match(/\.(xlsx|xls)$/i)) {
      setParseError("- Please upload an Excel file (.xlsx or .xls)");
      return;
    }
    setLoading(true); setParseError(null);
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type:"array" });
        const parsed = parseExcelWorkbook(wb);
        if (!parsed || parsed._err) {
          setParseError('Could not read data:\n' + (parsed?._err || 'Unknown error') + '\n\nSheets in file: ' + wb.SheetNames.join(", "));
          setLoading(false); return;
        }
        setUploadedData(parsed); setFileName(file.name);
        setSelIdx(null); // reset to last date of new file
        setParseError(null); setShowUpload(false);
      } catch (err) { setParseError("- Error: " + err.message); }
      setLoading(false);
    };
    reader.onerror = () => { setParseError("- Could not read file."); setLoading(false); };
    reader.readAsArrayBuffer(file);
  }, []);

  const onDrop      = useCallback((e) => { e.preventDefault(); setDragging(false); handleFile(e.dataTransfer?.files?.[0]); }, [handleFile]);
  const onDragOver  = useCallback((e) => { e.preventDefault(); setDragging(true); }, []);
  const onDragLeave = useCallback(() => setDragging(false), []);
  const onFileChange= useCallback((e) => handleFile(e.target.files?.[0]), [handleFile]);

  // PDF
  // -- DAILY PDF - Modern auto-print -----------------------------------------
  function generateDailyPDF() {
    const trendNum   = parseFloat(trend);
    const trendSign  = trendNum > 0 ? "^" : trendNum < 0 ? "v" : "-";
    const trendColor = trendNum > 0 ? "#ef4444" : trendNum < 0 ? "#22c55e" : "#94a3b8";
    const trendLabel = trendNum > 0 ? "More than prev day" : trendNum < 0 ? "Less than prev day" : "Same as prev day";
    const dayPct     = grandTotal > 0 ? ((totalDay / grandTotal) * 100).toFixed(1) : 0;
    const nightPct   = grandTotal > 0 ? ((totalNight / grandTotal) * 100).toFixed(1) : 0;
    const now        = new Date();
    const dayNames   = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    const todayFull  = `${dayNames[now.getDay()]}, ${now.toLocaleDateString("en-GB",{day:"2-digit",month:"long",year:"numeric"})}`;

    const top5worst = sewerData.slice(0,5);
    const top5best  = sewerData.filter(s=>s.total>=20).slice(-5).reverse();
    const rangeLabel = mtdData.length < dailyData.length
      ? `${dailyData[0]?.date} -> ${selectedDay.date} (${mtdData.length} days)`
      : period;

    const html = `<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8"/>
<title>Daily Rework Report - ${selectedDay.date}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Inter',Arial,sans-serif;background:#f8fafc;color:#0f172a;-webkit-print-color-adjust:exact;print-color-adjust:exact}

  /* -- HEADER -- */
  .hdr{background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 45%,#4f46e5 100%);color:#fff;padding:28px 36px;display:flex;justify-content:space-between;align-items:flex-start}
  .hdr-left .badge{display:inline-block;background:rgba(255,255,255,.15);font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:3px 10px;border-radius:20px;margin-bottom:8px}
  .hdr-left h1{font-size:24px;font-weight:900;letter-spacing:-0.5px;line-height:1.1}
  .hdr-left .sub{font-size:12px;opacity:.75;margin-top:5px}
  .hdr-right{text-align:right}
  .hdr-right .date-big{font-size:28px;font-weight:900;letter-spacing:-1px;line-height:1}
  .hdr-right .date-label{font-size:10px;opacity:.7;margin-top:4px}
  .hdr-right .gen{font-size:9px;opacity:.55;margin-top:6px}

  /* -- TODAY BANNER -- */
  .today-band{background:#0f172a;padding:20px 36px;display:grid;grid-template-columns:repeat(5,1fr);gap:0;border-bottom:3px solid #1e40af}
  .tb-item{padding:0 16px;border-right:1px solid #1e293b}
  .tb-item:first-child{padding-left:0}
  .tb-item:last-child{border-right:none}
  .tb-lbl{font-size:9px;color:#64748b;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
  .tb-val{font-size:26px;font-weight:900;line-height:1;color:#f1f5f9}
  .tb-sub{font-size:10px;color:#475569;margin-top:3px}

  /* -- SECTION -- */
  .sec{padding:22px 36px}
  .sec-title{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#94a3b8;margin-bottom:14px;padding-bottom:6px;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px}
  .sec-title span{font-size:11px;font-weight:700;color:#0f172a}

  /* -- SHIFT CARDS -- */
  .shift-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:20px}
  .kc{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px 14px;position:relative;overflow:hidden}
  .kc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent)}
  .kc.blue{--accent:#3b82f6}.kc.amber{--accent:#f59e0b}.kc.green{--accent:#10b981}.kc.red{--accent:#ef4444}.kc.purple{--accent:#8b5cf6}
  .kc-lbl{font-size:9px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-weight:600}
  .kc-val{font-size:28px;font-weight:900;color:#0f172a;line-height:1;letter-spacing:-1px}
  .kc-sub{font-size:10px;color:#64748b;margin-top:5px}
  .kc-bar{height:5px;background:#f1f5f9;border-radius:999;margin-top:8px;overflow:hidden}
  .kc-bar-fill{height:100%;border-radius:999;background:var(--accent)}

  /* -- PROGRESS BANNER -- */
  .prog-band{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;gap:16px}
  .prog-label{font-size:11px;color:#475569;white-space:nowrap;min-width:130px}
  .prog-track{flex:1;background:#f1f5f9;border-radius:999;height:12px;overflow:hidden;position:relative}
  .prog-fill-day{height:100%;border-radius:999 0 0 999;background:#3b82f6;display:inline-block;float:left}
  .prog-fill-night{height:100%;border-radius:0 999 999 0;background:#f59e0b;display:inline-block;float:left}
  .prog-vals{font-size:11px;white-space:nowrap;color:#475569}

  /* -- TABLE -- */
  .tbl-wrap{background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden}
  table{width:100%;border-collapse:collapse;font-size:11px}
  thead th{background:#1e40af;color:#fff;padding:9px 12px;font-weight:700;font-size:10px;letter-spacing:.5px;text-transform:uppercase}
  thead th:not(:first-child){text-align:right}
  tbody td{padding:7px 12px;border-bottom:1px solid #f1f5f9;color:#334155}
  tbody td:not(:first-child){text-align:right}
  tbody tr:nth-child(even) td{background:#f8fafc}
  tbody tr.today-row td{background:#eff6ff!important;color:#1e40af;font-weight:700}
  tbody tr.today-row td:first-child::after{content:' < Latest';font-size:9px;color:#3b82f6;margin-left:4px}
  tfoot td{padding:9px 12px;background:#0f172a;color:#fff;font-weight:800;font-size:11px}
  tfoot td:not(:first-child){text-align:right}

  /* -- SEWER MINI TABLE -- */
  .sewer-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:0}
  .sewer-card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden}
  .sewer-card-hdr{padding:10px 14px;font-size:10px;font-weight:700;display:flex;align-items:center;gap:6px}
  .sewer-card-hdr.red{background:#fef2f2;color:#dc2626;border-bottom:1px solid #fecaca}
  .sewer-card-hdr.green{background:#f0fdf4;color:#16a34a;border-bottom:1px solid #bbf7d0}
  .sewer-mini-table{width:100%;border-collapse:collapse;font-size:10px}
  .sewer-mini-table th{padding:5px 10px;background:#f8fafc;color:#64748b;font-size:9px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid #f1f5f9}
  .sewer-mini-table th:not(:first-child){text-align:right}
  .sewer-mini-table td{padding:6px 10px;border-bottom:1px solid #f8fafc;color:#334155}
  .sewer-mini-table td:not(:first-child){text-align:right}
  .sewer-mini-table tr:last-child td{border-bottom:none}
  .rank-badge{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;font-size:8px;font-weight:800;background:#f1f5f9;color:#64748b;margin-right:2px}
  .rank-badge.r1{background:#fef2f2;color:#ef4444}.rank-badge.g1{background:#f0fdf4;color:#22c55e}

  /* -- FOOTER -- */
  .ftr{background:#0f172a;padding:14px 36px;display:flex;justify-content:space-between;align-items:center}
  .ftr-left{font-size:10px;color:#475569}
  .ftr-right{font-size:10px;color:#334155;text-align:right}
  .confidential{background:#ef4444;color:#fff;font-size:9px;font-weight:700;letter-spacing:1px;padding:2px 8px;border-radius:4px;text-transform:uppercase}

  /* -- PRINT -- */
  @media print{
    *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
    @page{margin:0;size:A4 portrait}
    body{margin:0}
  }
</style>
</head>
<body onload="setTimeout(()=>window.print(),400)">

<!-- HEADER -->
<div class="hdr">
  <div class="hdr-left">
    <div class="badge">? Rework Tracking System</div>
    <h1>Daily Rework Report</h1>
    <div class="sub">Defective Bags Re-sewn - ${rangeLabel} - Source: ${fileName||"Re-sewn Bags February 2026.xlsx"}</div>
  </div>
  <div class="hdr-right">
    <div class="date-big">${selectedDay.date}</div>
    <div class="date-label">${isLastDate?"Latest working day":"Selected working day"}</div>
    <div class="gen">Generated ${todayFull}</div>
  </div>
</div>

<!-- TODAY BANNER -->
<div class="today-band">
  <div class="tb-item">
    <div class="tb-lbl">Selected Day Total</div>
    <div class="tb-val" style="color:#60a5fa">${selectedDay.total}</div>
    <div class="tb-sub">Re-sewn bags</div>
  </div>
  <div class="tb-item">
    <div class="tb-lbl">Day Shift</div>
    <div class="tb-val" style="color:#93c5fd">${selectedDay.shiftDay}</div>
    <div class="tb-sub">${selectedDay.total>0?((selectedDay.shiftDay/selectedDay.total)*100).toFixed(0):0}% of day</div>
  </div>
  <div class="tb-item">
    <div class="tb-lbl">Night Shift</div>
    <div class="tb-val" style="color:#fcd34d">${selectedDay.shiftNight}</div>
    <div class="tb-sub">${selectedDay.total>0?((selectedDay.shiftNight/selectedDay.total)*100).toFixed(0):0}% of day</div>
  </div>
  <div class="tb-item">
    <div class="tb-lbl">vs Prev Day (${prevDay.date||"-"})</div>
    <div class="tb-val" style="color:${trendColor}">${trendSign} ${Math.abs(trendNum)}%</div>
    <div class="tb-sub" style="color:#64748b">${trendLabel}</div>
  </div>
  <div class="tb-item">
    <div class="tb-lbl">Period Total (MTD)</div>
    <div class="tb-val" style="color:#a5b4fc">${grandTotal.toLocaleString()}</div>
    <div class="tb-sub">${mtdData.length} working days</div>
  </div>
</div>

<!-- KPI CARDS -->
<div class="sec" style="background:#f8fafc">
  <div class="sec-title">- <span>Period KPIs</span> - ${rangeLabel}</div>
  <div class="shift-grid">
    <div class="kc blue">
      <div class="kc-lbl">Total Re-sewn (MTD)</div>
      <div class="kc-val">${grandTotal.toLocaleString()}</div>
      <div class="kc-sub">${dailyData.length} working days</div>
      <div class="kc-bar"><div class="kc-bar-fill" style="width:100%"></div></div>
    </div>
    <div class="kc blue">
      <div class="kc-lbl">Day Shift Total</div>
      <div class="kc-val">${totalDay.toLocaleString()}</div>
      <div class="kc-sub">${dayPct}% of total</div>
      <div class="kc-bar"><div class="kc-bar-fill" style="width:${dayPct}%"></div></div>
    </div>
    <div class="kc amber">
      <div class="kc-lbl">Night Shift Total</div>
      <div class="kc-val">${totalNight.toLocaleString()}</div>
      <div class="kc-sub">${nightPct}% of total</div>
      <div class="kc-bar"><div class="kc-bar-fill" style="width:${nightPct}%"></div></div>
    </div>
    <div class="kc green">
      <div class="kc-lbl">Daily Average</div>
      <div class="kc-val">${avgDaily}</div>
      <div class="kc-sub">bags/day avg</div>
      <div class="kc-bar"><div class="kc-bar-fill" style="width:${Math.min(100,(parseFloat(avgDaily)/maxDay.total*100).toFixed(0))}%"></div></div>
    </div>
  </div>
  <!-- Month progress bar -->
  <div class="prog-band">
    <div class="prog-label">Shift split - ${period}</div>
    <div class="prog-track">
      <div class="prog-fill-day" style="width:${dayPct}%"></div>
      <div class="prog-fill-night" style="width:${nightPct}%"></div>
    </div>
    <div class="prog-vals">
      <span style="color:#3b82f6;font-weight:700">Day ${dayPct}%</span>
      &nbsp;/&nbsp;
      <span style="color:#f59e0b;font-weight:700">Night ${nightPct}%</span>
    </div>
  </div>
</div>

<!-- DAILY TABLE -->
<div class="sec" style="padding-top:0">
  <div class="sec-title">- <span>Daily Breakdown</span> - All Working Days</div>
  <div class="tbl-wrap">
    <table>
      <thead><tr>
        <th>Date</th><th>Day Shift</th><th>Night Shift</th><th>Total</th><th>vs Avg (${avgDaily})</th>
      </tr></thead>
      <tbody>
        ${dailyData.map((d,i)=>{
          const diff = d.total - parseFloat(avgDaily);
          const isToday = i === dailyData.length - 1;
          const diffStr = (diff>0?"+":"")+diff.toFixed(0);
          const diffColor = diff>10?"#16a34a":diff<-10?"#dc2626":"#64748b";
          return `<tr${isToday?' class="today-row"':''}>
            <td>${d.date}</td>
            <td style="color:#1d4ed8">${d.shiftDay}</td>
            <td style="color:#d97706">${d.shiftNight}</td>
            <td style="font-weight:800">${d.total}</td>
            <td style="color:${diffColor};font-weight:600">${diffStr}</td>
          </tr>`;
        }).join("")}
      </tbody>
      <tfoot><tr>
        <td>TOTAL</td>
        <td style="color:#93c5fd">${totalDay.toLocaleString()}</td>
        <td style="color:#fcd34d">${totalNight.toLocaleString()}</td>
        <td>${grandTotal.toLocaleString()}</td>
        <td style="color:#94a3b8;font-weight:500;font-size:10px">avg ${avgDaily}/day</td>
      </tr></tfoot>
    </table>
  </div>
</div>

<!-- SEWER PERFORMANCE -->
<div class="sec" style="padding-top:0">
  <div class="sec-title">- <span>Sewer Performance</span> - Top 5 Worst &amp; Best</div>
  <div class="sewer-grid">
    <div class="sewer-card">
      <div class="sewer-card-hdr red">- Most Rework Sewers (Worst 5)</div>
      <table class="sewer-mini-table">
        <tr><th>#</th><th>Sewer ID</th><th>Role</th><th>Total</th></tr>
        ${top5worst.map((s,i)=>`<tr>
          <td><span class="rank-badge r1">${i+1}</span></td>
          <td style="font-weight:700">${s.id}</td>
          <td style="color:#94a3b8">${s.top>0&&s.bottom>0?"T+B":s.top>0?"Top":"Bot"}</td>
          <td style="font-weight:800;color:#dc2626">${s.total}</td>
        </tr>`).join("")}
      </table>
    </div>
    <div class="sewer-card">
      <div class="sewer-card-hdr green">? Least Rework Sewers (Best 5)</div>
      <table class="sewer-mini-table">
        <tr><th>#</th><th>Sewer ID</th><th>Role</th><th>Total</th></tr>
        ${top5best.map((s,i)=>`<tr>
          <td><span class="rank-badge g1">${i+1}</span></td>
          <td style="font-weight:700">${s.id}</td>
          <td style="color:#94a3b8">${s.top>0&&s.bottom>0?"T+B":s.top>0?"Top":"Bot"}</td>
          <td style="font-weight:800;color:#16a34a">${s.total}</td>
        </tr>`).join("")}
      </table>
    </div>
  </div>
</div>

<!-- FOOTER -->
<div class="ftr">
  <div class="ftr-left">
    Re-sewn Bags Rework Dashboard &nbsp;-&nbsp; ${period} &nbsp;-&nbsp;
    Selected day: <b style="color:#f1f5f9">${selectedDay.date}</b> &nbsp;-&nbsp;
    Source: ${fileName||"Re-sewn Bags February 2026.xlsx"}
  </div>
  <div style="display:flex;align-items:center;gap:10px">
    <span class="ftr-right">${now.toLocaleString()}</span>
    <span class="confidential">Confidential</span>
  </div>
</div>

</body></html>`;

    const w = window.open("","_blank");
    if (w) { w.document.write(html); w.document.close(); }
  }

  // -- MONTHLY PDF ------------------------------------------------------------
  function generateMonthlyPDF() {
    const sewerRows = sewerData.filter(s => s.total > 0)
      .map((s,i) => `<tr><td>${i+1}</td><td><b>${s.id}</b></td><td style="text-align:center">${s.top||"-"}</td><td style="text-align:center">${s.bottom||"-"}</td><td style="text-align:center;font-weight:800">${s.total}</td><td style="text-align:center">${s.top>0&&s.bottom>0?"T+B":s.top>0?"Top":"Bot"}</td></tr>`).join("");
    const html = `<!DOCTYPE html><html><head><title>Monthly Rework Report - ${period}</title>
    <style>
      *{box-sizing:border-box;margin:0;padding:0}
      body{font-family:Arial,sans-serif;color:#1f2937;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      .hdr{background:linear-gradient(135deg,#1e3a8a,#4f46e5);color:#fff;padding:24px 32px;display:flex;justify-content:space-between;align-items:center}
      .hdr h1{font-size:20px;font-weight:800}.hdr .sub{font-size:11px;opacity:.8;margin-top:3px}
      .hdr-right{text-align:right;font-size:11px;opacity:.8}
      .body{padding:24px 32px}
      h2{color:#1e3a8a;font-size:13px;font-weight:700;margin:20px 0 8px;border-left:4px solid #3b82f6;padding-left:8px;text-transform:uppercase;letter-spacing:.5px}
      .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
      .kpi{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px;text-align:center}
      .kpi-val{font-size:22px;font-weight:800;color:#1d4ed8}.kpi-lbl{font-size:10px;color:#6b7280;margin-top:2px}
      table{width:100%;border-collapse:collapse;font-size:11px;margin-bottom:16px}
      th{background:#1e40af;color:#fff;padding:7px 10px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:.5px}
      td{padding:6px 10px;border-bottom:1px solid #e5e7eb}
      tr:nth-child(even) td{background:#f9fafb}
      .foot{margin-top:20px;text-align:center;font-size:10px;color:#9ca3af;border-top:1px solid #e5e7eb;padding-top:10px}
      @media print{@page{margin:0;size:A4}*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}}
    </style></head>
    <body onload="setTimeout(()=>window.print(),400)">
    <div class="hdr">
      <div><div style="font-size:10px;opacity:.7;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Monthly Report</div>
        <h1>Re-sewn Bags - ${period}</h1>
        <div class="sub">Defective Bags Re-sewn - Source: ${fileName||"Re-sewn Bags February 2026.xlsx"}</div></div>
      <div class="hdr-right">Generated: ${new Date().toLocaleString()}<br/>${dailyData.length} working days - ${sewerData.filter(s=>s.total>0).length} sewers</div>
    </div>
    <div class="body">
    <h2>Key Performance Indicators</h2>
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-val">${grandTotal.toLocaleString()}</div><div class="kpi-lbl">Total Re-sewn Bags</div></div>
      <div class="kpi"><div class="kpi-val">${avgDaily}</div><div class="kpi-lbl">Daily Average</div></div>
      <div class="kpi"><div class="kpi-val">${maxDay.total}</div><div class="kpi-lbl">Worst Day (${maxDay.date})</div></div>
      <div class="kpi"><div class="kpi-val">${minDay.total}</div><div class="kpi-lbl">Best Day (${minDay.date})</div></div>
    </div>
    <h2>Daily Summary</h2>
    <table><tr><th>Date</th><th>Day Shift</th><th>Night Shift</th><th>Total</th><th>vs Avg</th></tr>
      ${dailyData.map(d=>{const diff=d.total-parseFloat(avgDaily);return`<tr><td>${d.date}</td><td style="color:#1d4ed8">${d.shiftDay}</td><td style="color:#d97706">${d.shiftNight}</td><td style="font-weight:800">${d.total}</td><td style="color:${diff>10?"#16a34a":diff<-10?"#dc2626":"#6b7280"}">${diff>0?"+":""}${diff.toFixed(0)}</td></tr>`;}).join("")}
      <tr style="background:#dbeafe"><td><b>TOTAL</b></td><td><b>${totalDay}</b></td><td><b>${totalNight}</b></td><td><b>${grandTotal}</b></td><td style="color:#6b7280">avg ${avgDaily}</td></tr>
    </table>
    <h2>Sewer Performance - All ${sewerData.filter(s=>s.total>0).length} Sewers</h2>
    <table><tr><th>#</th><th>Sewer ID</th><th>Top Repaired</th><th>Bottom Repaired</th><th>Total</th><th>Role</th></tr>
      ${sewerRows}
    </table>
    <h2>Top 10 Machines</h2>
    <table><tr><th>Machine</th><th>Re-sewn Bags</th></tr>
      ${machineData.map(m=>`<tr><td>${m.machine}</td><td>${m.rework}</td></tr>`).join("")}
    </table>
    <h2>By Production Line</h2>
    <table><tr><th>Line</th><th>Re-sewn Bags</th></tr>
      ${lineData.map(l=>`<tr><td>${l.line}</td><td>${l.rework}</td></tr>`).join("")}
    </table>
    <div class="foot">Re-sewn Bags Rework Dashboard - ${period} - CONFIDENTIAL - ${new Date().toLocaleDateString()}</div>
    </div></body></html>`;
    const w = window.open("","_blank");
    if (w) { w.document.write(html); w.document.close(); }
  }

  const S = {
    card:  { background:"#0f172a", border:"1px solid #1e293b", borderRadius:16, padding:16 },
    title: { fontWeight:600, fontSize:14, color:"#f1f5f9" },
    sub:   { fontSize:11, color:"#64748b" },
  };

  return (
    <div style={{ minHeight:"100vh", background:"#030712", color:"#f9fafb", fontFamily:"'Inter',system-ui,sans-serif" }}
      onDrop={onDrop} onDragOver={onDragOver} onDragLeave={onDragLeave}>

      {/* -
          DAY DETAIL MODAL
          - */}
      {showDayModal && (() => {
        const dayKey  = selectedDay.date;
        const ds      = dailySewers[dayKey] || { worst:[], best:[], worst_mc:[], worst_line:[] };
        const trendN  = parseFloat(trend);
        const maxRw   = ds.worst[0]?.total || 1;
        const maxBest = ds.best[0]?.total  || 1;
        return (
          <div style={{ position:"fixed", inset:0, zIndex:300, background:"rgba(0,0,0,.75)",
            display:"flex", alignItems:"center", justifyContent:"center", padding:"16px",
            backdropFilter:"blur(4px)" }}
            onClick={e => e.target===e.currentTarget && setShowDayModal(false)}>

            <div style={{ background:"#0a0f1e", border:"1px solid #1e293b", borderRadius:20,
              width:"100%", maxWidth:800, maxHeight:"90vh", overflowY:"auto",
              boxShadow:"0 25px 60px rgba(0,0,0,.6)", position:"relative" }}>

              {/* -- MODAL HEADER -- */}
              <div style={{ background:"linear-gradient(135deg,#1e3a8a,#4f46e5)",
                padding:"20px 24px", borderRadius:"20px 20px 0 0", position:"sticky", top:0, zIndex:10 }}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start" }}>
                  <div>
                    <div style={{ fontSize:10, color:"rgba(255,255,255,.6)", letterSpacing:"1.5px",
                      textTransform:"uppercase", marginBottom:4 }}>- Day Details</div>
                    <div style={{ fontSize:26, fontWeight:900, color:"#fff", letterSpacing:"-1px" }}>{dayKey}</div>
                    <div style={{ fontSize:12, color:"rgba(255,255,255,.65)", marginTop:3 }}>
                      {period} - {isLastDate ? "Latest working day" : `Day ${clampedIdx+1} of ${dailyData.length}`}
                    </div>
                  </div>
                  <div style={{ display:"flex", gap:8, alignItems:"center" }}>
                    <button onClick={() => { setSelIdx(i => Math.max(0,(i-clampedIdx)-1)); }}
                      disabled={clampedIdx===0}
                      style={{ background:"rgba(255,255,255,.15)", border:"none", borderRadius:8,
                        color:"#fff", padding:"6px 10px", cursor:clampedIdx===0?"not-allowed":"pointer",
                        opacity:clampedIdx===0?0.4:1 }}>
                      <ChevronLeft size={14}/>
                    </button>
                    <button onClick={() => { setSelIdx(i => Math.min(dailyData.length-1,(i-clampedIdx)+1)); }}
                      disabled={isLastDate}
                      style={{ background:"rgba(255,255,255,.15)", border:"none", borderRadius:8,
                        color:"#fff", padding:"6px 10px", cursor:isLastDate?"not-allowed":"pointer",
                        opacity:isLastDate?0.4:1 }}>
                      <ChevronRight size={14}/>
                    </button>
                    <button onClick={() => setShowDayModal(false)}
                      style={{ background:"rgba(255,255,255,.15)", border:"none", borderRadius:8,
                        color:"#fff", padding:"6px 10px", cursor:"pointer", fontSize:16 }}>?</button>
                  </div>
                </div>
                {/* Day KPI strip */}
                <div style={{ display:"grid", gridTemplateColumns:"repeat(4,1fr)", gap:10, marginTop:16 }}>
                  {[
                    { label:"Total Bags", value:selectedDay.total, color:"#93c5fd", sub:"re-sewn" },
                    { label:"Day Shift",  value:selectedDay.shiftDay,   color:"#60a5fa",
                      sub:selectedDay.total>0?`${((selectedDay.shiftDay/selectedDay.total)*100).toFixed(0)}%`:"-" },
                    { label:"Night Shift",value:selectedDay.shiftNight, color:"#fcd34d",
                      sub:selectedDay.total>0?`${((selectedDay.shiftNight/selectedDay.total)*100).toFixed(0)}%`:"-" },
                    { label:`vs ${prevDay.date||"prev"}`, color: trendN>0?"#f87171":"#4ade80",
                      value:`${trendN>0?"^ +":"v "}${Math.abs(trendN)}%`, sub:trendN>0?"More rework":"Less rework" },
                  ].map((k,i)=>(
                    <div key={i} style={{ background:"rgba(255,255,255,.08)", borderRadius:10, padding:"10px 12px" }}>
                      <div style={{ fontSize:9, color:"rgba(255,255,255,.5)", textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:3 }}>{k.label}</div>
                      <div style={{ fontSize:20, fontWeight:900, color:k.color, lineHeight:1 }}>{k.value}</div>
                      <div style={{ fontSize:10, color:"rgba(255,255,255,.4)", marginTop:2 }}>{k.sub}</div>
                    </div>
                  ))}
                </div>
              </div>

              {/* -- MODAL BODY -- */}
              <div style={{ padding:"20px 24px", display:"flex", flexDirection:"column", gap:16 }}>

                {/* Sewers section */}
                <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:14 }}>

                  {/* WORST SEWERS */}
                  <div style={{ background:"#0f172a", border:"1px solid rgba(239,68,68,.25)", borderRadius:14, overflow:"hidden" }}>
                    <div style={{ background:"rgba(239,68,68,.1)", padding:"10px 14px", borderBottom:"1px solid rgba(239,68,68,.2)",
                      display:"flex", alignItems:"center", gap:8 }}>
                      <span style={{ fontSize:16 }}>-</span>
                      <div>
                        <div style={{ fontSize:12, fontWeight:800, color:"#f87171" }}>Worst Sewers</div>
                        <div style={{ fontSize:10, color:"#64748b" }}>Most rework bags - {dayKey}</div>
                      </div>
                    </div>
                    <div style={{ padding:"10px 14px" }}>
                      {ds.worst.length === 0
                        ? <div style={{ fontSize:11, color:"#475569", textAlign:"center", padding:"12px" }}>No data</div>
                        : ds.worst.map((s,i) => (
                          <div key={s.id} style={{ display:"flex", alignItems:"center", gap:10,
                            padding:"7px 0", borderBottom:i<ds.worst.length-1?"1px solid rgba(30,41,59,.5)":"none" }}>
                            <div style={{ width:22, height:22, borderRadius:"50%", flexShrink:0,
                              background:i===0?"rgba(239,68,68,.2)":i===1?"rgba(249,115,22,.15)":"rgba(30,41,59,.5)",
                              display:"flex", alignItems:"center", justifyContent:"center",
                              fontSize:10, fontWeight:800, color:i===0?"#f87171":i===1?"#fb923c":"#64748b" }}>
                              {i+1}
                            </div>
                            <div style={{ flex:1, minWidth:0 }}>
                              <div style={{ fontSize:13, fontWeight:700, color:"#f1f5f9" }}>ID: {s.id}</div>
                              <div style={{ background:"#1e293b", borderRadius:999, height:5, marginTop:4, overflow:"hidden" }}>
                                <div style={{ height:"100%", width:`${(s.total/maxRw*100).toFixed(0)}%`,
                                  background:i===0?"#ef4444":i===1?"#f97316":"#3b82f6", borderRadius:999 }}/>
                              </div>
                            </div>
                            <div style={{ fontSize:16, fontWeight:900, color:i===0?"#f87171":"#f1f5f9", minWidth:28, textAlign:"right" }}>
                              {s.total}
                            </div>
                            <div style={{ fontSize:9, color:"#475569", minWidth:24 }}>bags</div>
                          </div>
                        ))
                      }
                    </div>
                  </div>

                  {/* BEST SEWERS */}
                  <div style={{ background:"#0f172a", border:"1px solid rgba(34,197,94,.2)", borderRadius:14, overflow:"hidden" }}>
                    <div style={{ background:"rgba(34,197,94,.08)", padding:"10px 14px", borderBottom:"1px solid rgba(34,197,94,.15)",
                      display:"flex", alignItems:"center", gap:8 }}>
                      <span style={{ fontSize:16 }}>-</span>
                      <div>
                        <div style={{ fontSize:12, fontWeight:800, color:"#4ade80" }}>Best Sewers</div>
                        <div style={{ fontSize:10, color:"#64748b" }}>Least rework bags - {dayKey}</div>
                      </div>
                    </div>
                    <div style={{ padding:"10px 14px" }}>
                      {ds.best.length === 0
                        ? <div style={{ fontSize:11, color:"#475569", textAlign:"center", padding:"12px" }}>No data</div>
                        : ds.best.map((s,i) => (
                          <div key={s.id} style={{ display:"flex", alignItems:"center", gap:10,
                            padding:"7px 0", borderBottom:i<ds.best.length-1?"1px solid rgba(30,41,59,.5)":"none" }}>
                            <div style={{ width:22, height:22, borderRadius:"50%", flexShrink:0,
                              background:i===0?"rgba(34,197,94,.2)":i===1?"rgba(20,184,166,.15)":"rgba(30,41,59,.5)",
                              display:"flex", alignItems:"center", justifyContent:"center",
                              fontSize:10, fontWeight:800, color:i===0?"#4ade80":i===1?"#2dd4bf":"#64748b" }}>
                              {i+1}
                            </div>
                            <div style={{ flex:1, minWidth:0 }}>
                              <div style={{ fontSize:13, fontWeight:700, color:"#f1f5f9" }}>ID: {s.id}</div>
                              <div style={{ background:"#1e293b", borderRadius:999, height:5, marginTop:4, overflow:"hidden" }}>
                                <div style={{ height:"100%", width:`${(s.total/maxBest*100).toFixed(0)}%`,
                                  background:i===0?"#22c55e":i===1?"#14b8a6":"#6366f1", borderRadius:999 }}/>
                              </div>
                            </div>
                            <div style={{ fontSize:16, fontWeight:900, color:i===0?"#4ade80":"#f1f5f9", minWidth:28, textAlign:"right" }}>
                              {s.total}
                            </div>
                            <div style={{ fontSize:9, color:"#475569", minWidth:24 }}>bags</div>
                          </div>
                        ))
                      }
                    </div>
                  </div>
                </div>

                {/* Machine + Line for that day */}
                <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:14 }}>
                  {[
                    { title:"- Top Machines", sub:"Most rework that day", color:"#a78bfa", items:ds.worst_mc,
                      key:"machine", valKey:"rework" },
                    { title:"- Top Lines",    sub:"Most rework that day", color:"#34d399", items:ds.worst_line,
                      key:"line",    valKey:"rework" },
                  ].map((sec,si)=>(
                    <div key={si} style={{ background:"#0f172a", border:"1px solid #1e293b", borderRadius:14, padding:"14px" }}>
                      <div style={{ fontSize:12, fontWeight:700, color:sec.color, marginBottom:2 }}>{sec.title}</div>
                      <div style={{ fontSize:10, color:"#64748b", marginBottom:10 }}>{sec.sub} - {dayKey}</div>
                      {(sec.items||[]).map((item,i)=>{
                        const mx = sec.items[0]?.[sec.valKey] || 1;
                        return (
                          <div key={i} style={{ display:"flex", alignItems:"center", gap:8,
                            padding:"6px 0", borderBottom:i<sec.items.length-1?"1px solid rgba(30,41,59,.5)":"none" }}>
                            <span style={{ fontSize:10, color:"#475569", fontWeight:700, minWidth:14 }}>{i+1}</span>
                            <div style={{ flex:1 }}>
                              <div style={{ fontSize:12, fontWeight:600, color:"#f1f5f9" }}>{item[sec.key]}</div>
                              <div style={{ background:"#1e293b", borderRadius:999, height:4, marginTop:3, overflow:"hidden" }}>
                                <div style={{ height:"100%", width:`${(item[sec.valKey]/mx*100).toFixed(0)}%`,
                                  background:sec.color, borderRadius:999 }}/>
                              </div>
                            </div>
                            <span style={{ fontSize:14, fontWeight:800, color:sec.color }}>{item[sec.valKey]}</span>
                          </div>
                        );
                      })}
                    </div>
                  ))}
                </div>

                {/* Footer nav */}
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center",
                  paddingTop:8, borderTop:"1px solid #1e293b" }}>
                  <button onClick={() => { if(clampedIdx>0) setSelIdx(clampedIdx-1); }}
                    disabled={clampedIdx===0}
                    style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 14px",
                      background:"#1e293b", border:"1px solid #334155", borderRadius:8,
                      color:clampedIdx===0?"#334155":"#94a3b8", fontSize:11, cursor:clampedIdx===0?"not-allowed":"pointer" }}>
                    <ChevronLeft size={13}/> {clampedIdx>0 ? dailyData[clampedIdx-1]?.date : "-"}
                  </button>
                  <button onClick={() => generateDailyPDF()}
                    style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 16px",
                      background:"linear-gradient(135deg,#1e40af,#4f46e5)", border:"none",
                      borderRadius:8, color:"#fff", fontSize:11, fontWeight:700, cursor:"pointer" }}>
                    <Printer size={13}/> Export PDF for {dayKey}
                  </button>
                  <button onClick={() => { if(!isLastDate) setSelIdx(clampedIdx+1); }}
                    disabled={isLastDate}
                    style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 14px",
                      background:"#1e293b", border:"1px solid #334155", borderRadius:8,
                      color:isLastDate?"#334155":"#94a3b8", fontSize:11, cursor:isLastDate?"not-allowed":"pointer" }}>
                    {!isLastDate ? dailyData[clampedIdx+1]?.date : "-"} <ChevronRight size={13}/>
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      })()}

      {/* DRAG OVERLAY */}
      {dragging && (
        <div style={{ position:"fixed", inset:0, zIndex:200, background:"rgba(3,7,18,.85)",
          display:"flex", alignItems:"center", justifyContent:"center", pointerEvents:"none" }}>
          <div style={{ border:"2px dashed #3b82f6", borderRadius:20, padding:"40px 60px", textAlign:"center" }}>
            <Upload size={40} color="#3b82f6" style={{ margin:"0 auto 12px" }}/>
            <div style={{ fontSize:18, fontWeight:700, color:"#60a5fa" }}>Drop your Excel file here</div>
            <div style={{ fontSize:13, color:"#64748b", marginTop:4 }}>Supports .xlsx / .xls</div>
          </div>
        </div>
      )}

      {/* HEADER */}
      <header style={{ background:"#0f172a", borderBottom:"1px solid #1e293b", padding:"12px 20px",
        display:"flex", alignItems:"center", justifyContent:"space-between", position:"sticky", top:0, zIndex:50, flexWrap:"wrap", gap:8 }}>
        <div style={{ display:"flex", alignItems:"center", gap:10 }}>
          <div style={{ width:36, height:36, background:"linear-gradient(135deg,#ef4444,#b91c1c)",
            borderRadius:10, display:"flex", alignItems:"center", justifyContent:"center" }}>
            <Scissors size={17} color="#fff"/>
          </div>
          <div>
            <div style={{ fontWeight:700, fontSize:15, color:"#f1f5f9" }}>Re-sewn Bags - Rework Tracking</div>
            <div style={S.sub}>
              Defective Bags Re-sewn - {mtdPeriod} - {mtdData.length}/{dailyData.length} days
              {isDefault && <span style={{ color:"#ef4444", marginLeft:6 }}>- Default data</span>}
              {!isDefault && <span style={{ color:"#22c55e", marginLeft:6 }}>- Live from Excel ?</span>}
              {!isLastDate && <span style={{ color:"#f59e0b", marginLeft:6 }}>- Viewing {selectedDay.date}</span>}
            </div>
          </div>
        </div>
        <div style={{ display:"flex", gap:8, flexWrap:"wrap", alignItems:"center" }}>

          {/* -- VIEW MODE TOGGLE -- */}
          <div style={{ display:"flex", background:"#1e293b", border:"1px solid #334155", borderRadius:8, overflow:"hidden" }}>
            {[["month","- Month"],["day","- Day"]].map(([mode, label]) => (
              <button key={mode} onClick={() => { setViewMode(mode); if(mode==="day") setShowDayModal(true); }}
                style={{ padding:"7px 12px", border:"none", fontSize:11, fontWeight:600, cursor:"pointer",
                  background: viewMode===mode ? "linear-gradient(135deg,#1e40af,#4f46e5)" : "transparent",
                  color: viewMode===mode ? "#fff" : "#64748b", transition:"all .2s" }}>
                {label}
              </button>
            ))}
          </div>

          {/* -- DATE SELECTOR (always visible, more prominent in Day mode) -- */}
          <div style={{ display:"flex", alignItems:"center", gap:4,
            background:"#1e293b", border:`1px solid ${viewMode==="day"?"#3b82f6":"#334155"}`,
            borderRadius:8, padding:"4px 6px",
            boxShadow: viewMode==="day" ? "0 0 0 1px rgba(59,130,246,.3)" : "none" }}>
            <Calendar size={13} color={viewMode==="day"?"#60a5fa":"#64748b"}/>
            <button
              onClick={() => setSelIdx(i => Math.max(0, (i-clampedIdx) - 1))}
              disabled={clampedIdx === 0}
              style={{ background:"none", border:"none", color:clampedIdx===0?"#334155":"#94a3b8",
                cursor:clampedIdx===0?"not-allowed":"pointer", padding:"2px 3px", lineHeight:1 }}>
              <ChevronLeft size={13}/>
            </button>
            <select
              value={clampedIdx}
              onChange={e => { setSelIdx(parseInt(e.target.value)); if(viewMode==="day") setShowDayModal(true); }}
              style={{ background:"transparent", border:"none", color:"#f1f5f9",
                fontSize:12, fontWeight:700, cursor:"pointer", outline:"none",
                padding:"2px 0", maxWidth:72 }}>
              {dailyData.map((d,i) => (
                <option key={i} value={i} style={{ background:"#1e293b", color:"#f1f5f9" }}>
                  {d.date}{i === dailyData.length-1 ? " -" : ""}
                </option>
              ))}
            </select>
            <button
              onClick={() => { setSelIdx(i => Math.min(dailyData.length-1, (i-clampedIdx) + 1)); if(viewMode==="day") setShowDayModal(true); }}
              disabled={isLastDate}
              style={{ background:"none", border:"none", color:isLastDate?"#334155":"#94a3b8",
                cursor:isLastDate?"not-allowed":"pointer", padding:"2px 3px", lineHeight:1 }}>
              <ChevronRight size={13}/>
            </button>
            {!isLastDate && (
              <button onClick={() => setSelIdx(null)}
                style={{ background:"rgba(99,102,241,.25)", border:"none", color:"#a5b4fc",
                  fontSize:9, fontWeight:700, borderRadius:4, padding:"2px 5px", cursor:"pointer", marginLeft:2 }}>
                LATEST
              </button>
            )}
            {viewMode==="day" && (
              <button onClick={() => setShowDayModal(true)}
                style={{ background:"rgba(59,130,246,.3)", border:"none", color:"#93c5fd",
                  fontSize:9, fontWeight:700, borderRadius:4, padding:"2px 7px", cursor:"pointer", marginLeft:3,
                  whiteSpace:"nowrap" }}>
                VIEW >
              </button>
            )}
          </div>

          <button onClick={()=>setShowUpload(p=>!p)}
            style={{ display:"flex", alignItems:"center", gap:6, padding:"7px 14px",
              background:showUpload?"#1e40af":"#1e293b", border:"1px solid #334155",
              borderRadius:8, color:showUpload?"#fff":"#94a3b8", fontSize:12, cursor:"pointer" }}>
            <Upload size={13}/> {fileName ? "Change File" : "Upload Excel"}
          </button>
          <button onClick={generateDailyPDF}
            style={{ display:"flex", alignItems:"center", gap:6, padding:"7px 14px",
              background:"linear-gradient(135deg,#1e40af,#4f46e5)", border:"none",
              borderRadius:8, color:"#fff", fontSize:12, cursor:"pointer", fontWeight:600 }}>
            <Printer size={13}/> Daily PDF
          </button>
          <button onClick={generateMonthlyPDF}
            style={{ display:"flex", alignItems:"center", gap:6, padding:"7px 14px",
              background:"#4f46e5", border:"none", borderRadius:8, color:"#fff", fontSize:12, cursor:"pointer" }}>
            <Download size={13}/> Monthly PDF
          </button>
        </div>
      </header>

      {/* UPLOAD PANEL */}
      {showUpload && (
        <div style={{ background:"#0f172a", borderBottom:"1px solid #1e293b", padding:"16px 20px" }}>
          <div style={{ maxWidth:760, margin:"0 auto" }}>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:12 }}>
              <span style={{ fontWeight:600, fontSize:14, color:"#f1f5f9" }}>Upload Excel - dashboard updates instantly</span>
              <button onClick={()=>setShowUpload(false)} style={{ background:"none", border:"none", color:"#64748b", cursor:"pointer" }}><X size={18}/></button>
            </div>
            <div onClick={()=>fileRef.current?.click()}
              style={{ border:`2px dashed ${dragging?"#3b82f6":"#334155"}`, borderRadius:12, padding:"28px 16px",
                textAlign:"center", cursor:"pointer", background:"rgba(30,41,59,.4)" }}>
              {loading
                ? <div style={{ display:"flex", alignItems:"center", justifyContent:"center", gap:8, color:"#94a3b8" }}><RefreshCw size={20} color="#60a5fa"/>Reading file...</div>
                : <>
                    <Upload size={28} color="#3b82f6" style={{ margin:"0 auto 10px" }}/>
                    <div style={{ fontSize:13, color:"#94a3b8" }}>
                      <span style={{ color:"#60a5fa", fontWeight:600 }}>Click to browse</span> or drag &amp; drop
                    </div>
                    <div style={{ fontSize:11, color:"#475569", marginTop:6 }}>Supports .xlsx / .xls - Sheet: "Data Base"</div>
                  </>
              }
            </div>
            <input ref={fileRef} type="file" accept=".xlsx,.xls" onChange={onFileChange} style={{ display:"none" }}/>
            {parseError && (
              <div style={{ marginTop:10, padding:"10px 14px", background:"rgba(239,68,68,.1)",
                border:"1px solid rgba(239,68,68,.3)", borderRadius:8, fontSize:11, color:"#f87171", whiteSpace:"pre-wrap", fontFamily:"monospace" }}>{parseError}</div>
            )}
            {fileName && !parseError && (
              <div style={{ marginTop:10, padding:"10px 14px", background:"rgba(34,197,94,.08)",
                border:"1px solid rgba(34,197,94,.25)", borderRadius:8, fontSize:12, color:"#4ade80",
                display:"flex", alignItems:"center", gap:8 }}>
                <CheckCircle size={14}/>
                <span><b>{fileName}</b> loaded - {dailyData.length} days - {grandTotal.toLocaleString()} bags - {sewerData.length} sewers</span>
              </div>
            )}
            {!isDefault && (
              <button onClick={()=>{setUploadedData(null);setFileName(null);setParseError(null);setSelIdx(null);}}
                style={{ marginTop:10, background:"none", border:"1px solid #334155", borderRadius:8,
                  padding:"6px 12px", color:"#64748b", fontSize:11, cursor:"pointer" }}>
                Reset to default Feb 2026 data
              </button>
            )}
            <div style={{ marginTop:10, fontSize:11, color:"#475569" }}>
              - You can also drag &amp; drop anywhere on the dashboard
            </div>
          </div>
        </div>
      )}

      {/* REWORK-ONLY BANNER */}
      <div style={{ background:"rgba(127,29,29,.25)", borderBottom:"1px solid rgba(239,68,68,.2)", padding:"8px 20px" }}>
        <span style={{ fontSize:12, color:"#fca5a5" }}>
          - <b>Note:</b> All numbers represent <b>defective bags re-sewn</b> - production totals are not available.
          {isDefault && <span style={{ color:"#fbbf24" }}> - Upload your Excel file to see live data.</span>}
        </span>
      </div>

      {/* MAIN */}
      <main style={{ maxWidth:1280, margin:"0 auto", padding:"24px 16px", display:"flex", flexDirection:"column", gap:20 }}>

        {/* KPI CARDS */}
        <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))", gap:14 }}>
          {[
            { icon:<Package size={18} color="#60a5fa"/>, bg:"rgba(59,130,246,.12)",
              value:grandTotal.toLocaleString(), label:`Total Re-sewn (up to ${selectedDay.date})`,
              badge:<span style={{ fontSize:11, color:parseFloat(trend)>0?"#f87171":"#34d399", display:"flex", alignItems:"center", gap:2 }}>
                {parseFloat(trend)>0?<ChevronUp size={11}/>:<ChevronDown size={11}/>}{Math.abs(trend)}% vs prev
              </span> },
            { icon:<Activity size={18} color="#fb923c"/>, bg:"rgba(249,115,22,.12)",
              value:avgDaily, label:"Avg Re-sewn / Day",
              badge:<span style={{ fontSize:11, color:"#64748b" }}>over {dailyData.length} days</span> },
            { icon:<Award size={18} color="#4ade80"/>, bg:"rgba(74,222,128,.12)",
              value:bestShift, label:"Least Rework Shift",
              badge:<span style={{ fontSize:11, color:"#4ade80" }}>Fewest defects</span> },
            { icon:<ThumbsDown size={18} color="#f87171"/>, bg:"rgba(239,68,68,.12)",
              value:`ID: ${worstSewer.id}`, label:"Most Rework Sewer",
              badge:<span style={{ fontSize:11, color:"#f87171" }}>{worstSewer.total} bags</span> },
            { icon:<Star size={18} color="#4ade80"/>, bg:"rgba(74,222,128,.12)",
              value:`ID: ${bestSewer.id}`, label:"Least Rework Sewer (active)",
              badge:<span style={{ fontSize:11, color:"#4ade80" }}>{bestSewer.total} bags</span> },
            { icon:<Cpu size={18} color="#a78bfa"/>, bg:"rgba(139,92,246,.12)",
              value:topMachine.machine, label:"Most Rework Machine",
              badge:<span style={{ fontSize:11, color:"#a78bfa" }}>{topMachine.rework} bags</span> },
          ].map((c,i)=>(
            <div key={i} style={S.card}>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", marginBottom:10 }}>
                <div style={{ width:36, height:36, background:c.bg, borderRadius:10,
                  display:"flex", alignItems:"center", justifyContent:"center" }}>{c.icon}</div>
                {c.badge}
              </div>
              <div style={{ fontSize:21, fontWeight:800, color:"#f1f5f9", lineHeight:1.1, marginBottom:4, wordBreak:"break-word" }}>{c.value}</div>
              <div style={S.sub}>{c.label}</div>
            </div>
          ))}
        </div>

        {/* -- SELECTED DAY SUMMARY BANNER -- */}
        <div style={{ background:"linear-gradient(135deg,#0f1f3d,#1e3a8a)", border:"1px solid #1e40af",
          borderRadius:16, padding:"16px 20px", display:"grid",
          gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))", gap:12, position:"relative", overflow:"hidden" }}>
          <div style={{ position:"absolute", top:0, left:0, right:0, height:3,
            background:"linear-gradient(90deg,#3b82f6,#8b5cf6,#ec4899)" }}/>
          <div style={{ gridColumn:"1/-1", display:"flex", alignItems:"center", justifyContent:"space-between",
            marginBottom:4, flexWrap:"wrap", gap:8 }}>
            <div style={{ display:"flex", alignItems:"center", gap:8 }}>
              <Calendar size={15} color="#60a5fa"/>
              <span style={{ fontSize:13, fontWeight:700, color:"#f1f5f9" }}>
                Selected Day: <span style={{ color:"#60a5fa" }}>{selectedDay.date}</span>
              </span>
              {!isLastDate && <span style={{ fontSize:10, background:"rgba(245,158,11,.2)", color:"#fbbf24",
                padding:"2px 8px", borderRadius:999, fontWeight:600 }}>Historical</span>}
              {isLastDate && <span style={{ fontSize:10, background:"rgba(34,197,94,.15)", color:"#4ade80",
                padding:"2px 8px", borderRadius:999, fontWeight:600 }}>Latest</span>}
            </div>
            <span style={{ fontSize:11, color:"#475569" }}>
              vs prev ({prevDay.date||"-"}):
              <span style={{ fontWeight:700, color: parseFloat(trend)>0?"#f87171":"#4ade80", marginLeft:4 }}>
                {parseFloat(trend)>0?"^ +":"v "}{trend}%
              </span>
            </span>
          </div>
          {[
            { label:"Total", value:selectedDay.total, color:"#60a5fa", sub:"bags re-sewn" },
            { label:"Day Shift", value:selectedDay.shiftDay, color:C_DAY,
              sub:`${selectedDay.total>0?((selectedDay.shiftDay/selectedDay.total)*100).toFixed(0):0}% of day` },
            { label:"Night Shift", value:selectedDay.shiftNight, color:C_NIGHT,
              sub:`${selectedDay.total>0?((selectedDay.shiftNight/selectedDay.total)*100).toFixed(0):0}% of day` },
            { label:"vs Daily Avg", value:(selectedDay.total-parseFloat(avgDaily)).toFixed(0),
              color: selectedDay.total > parseFloat(avgDaily) ? "#f87171" : "#4ade80",
              sub:`Avg is ${avgDaily}`, prefix: selectedDay.total >= parseFloat(avgDaily) ? "+" : "" },
          ].map((item,i) => (
            <div key={i} style={{ background:"rgba(255,255,255,.04)", borderRadius:10, padding:"10px 12px" }}>
              <div style={{ fontSize:10, color:"#64748b", marginBottom:4, textTransform:"uppercase", letterSpacing:"0.5px" }}>{item.label}</div>
              <div style={{ fontSize:22, fontWeight:900, color:item.color, lineHeight:1 }}>
                {item.prefix||""}{item.value}
              </div>
              <div style={{ fontSize:10, color:"#475569", marginTop:3 }}>{item.sub}</div>
            </div>
          ))}
        </div>

        {/* SHIFT SUMMARY */}
        <div style={S.card}>
          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:14 }}>
            <div><div style={S.title}>Shift Summary - {mtdPeriod}</div><div style={S.sub}>Day vs Night - up to {selectedDay.date}</div></div>
            <Activity size={18} color="#4ade80"/>
          </div>
          <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
            {[
              { label:"Day Shift",   total:totalDay,   color:C_DAY,   pct:grandTotal>0?((totalDay/grandTotal)*100).toFixed(1):0 },
              { label:"Night Shift", total:totalNight, color:C_NIGHT, pct:grandTotal>0?((totalNight/grandTotal)*100).toFixed(1):0 },
            ].map((sh,i)=>(
              <div key={i} style={{ background:"#1e293b", borderRadius:12, padding:14 }}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
                  <span style={{ fontSize:12, color:"#94a3b8" }}>{sh.label}</span>
                  <span style={{ fontSize:18, fontWeight:800, color:sh.color }}>{sh.total.toLocaleString()}</span>
                </div>
                <div style={{ background:"#0f172a", borderRadius:999, height:8, overflow:"hidden" }}>
                  <div style={{ height:"100%", width:`${sh.pct}%`, background:sh.color, borderRadius:999 }}/>
                </div>
                <div style={{ fontSize:11, color:"#475569", marginTop:5 }}>
                  {sh.pct}% of total - avg {(sh.total/(dailyData.length||1)).toFixed(1)}/day
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* DAILY TREND */}
        <div style={S.card}>
          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:14 }}>
            <div><div style={S.title}>Daily Rework Trend - {period}</div>
              <div style={S.sub}>Day (blue) + Night (amber) - stacked - selected: <b style={{color:"#60a5fa"}}>{selectedDay.date}</b></div></div>
            <TrendingUp size={18} color="#60a5fa"/>
          </div>
          <ResponsiveContainer width="100%" height={260}>
            <ComposedChart data={dailyData} margin={{ top:4, right:4, left:-14, bottom:0 }}
              onClick={e => e?.activeTooltipIndex != null && setSelIdx(e.activeTooltipIndex)}>
              <CartesianGrid strokeDasharray="3 3" stroke="#1e293b"/>
              <XAxis dataKey="date" tick={{ fill:"#64748b", fontSize:10 }} tickLine={false}
                interval={Math.max(0,Math.floor(dailyData.length/10)-1)}/>
              <YAxis tick={{ fill:"#64748b", fontSize:10 }} tickLine={false}/>
              <Tooltip content={<Tip/>}/>
              <Legend wrapperStyle={{ fontSize:12, color:"#94a3b8", paddingTop:8 }}/>
              <Bar dataKey="shiftDay"   name="Day Shift"   stackId="s" fill={C_DAY}
                style={{ cursor:"pointer" }}/>
              <Bar dataKey="shiftNight" name="Night Shift" stackId="s" radius={[4,4,0,0]}
                style={{ cursor:"pointer" }}>
                {dailyData.map((_,i) => (
                  <Cell key={i} fill={i===clampedIdx?"#fbbf24":C_NIGHT}/>
                ))}
              </Bar>
              <Line dataKey="total" name="Total" stroke="#10B981" strokeWidth={2} dot={{ r:3, fill:"#10B981", strokeWidth:0 }}/>
              <ReferenceLine x={selectedDay.date} stroke="#60a5fa" strokeWidth={2} strokeDasharray="4 2"
                label={{ value:selectedDay.date, position:"top", fill:"#60a5fa", fontSize:10, fontWeight:700 }}/>
            </ComposedChart>
          </ResponsiveContainer>
          <div style={{ fontSize:10, color:"#475569", textAlign:"center", marginTop:4 }}>
            - Click any bar to select that date
          </div>
        </div>

        {/* - SEWER PERFORMANCE - */}
        <div style={{ background:"#0f172a", border:"1px solid #1e293b", borderRadius:16, padding:16 }}>
          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:16 }}>
            <div>
              <div style={{ ...S.title, fontSize:15 }}>- Sewer Performance Rankings - {period}</div>
              <div style={S.sub}>{sewerData.filter(s=>s.total>0).length} active sewers - Top & Bottom roles - sorted by total rework bags</div>
            </div>
            <Users size={20} color="#a78bfa"/>
          </div>

          <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(340px,1fr))", gap:16 }}>

            {/* WORST SEWERS */}
            <div style={{ background:"#0f172a", border:"1px solid rgba(239,68,68,.3)", borderRadius:12, padding:14 }}>
              <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:12 }}>
                <div style={{ width:28, height:28, background:"rgba(239,68,68,.15)", borderRadius:8,
                  display:"flex", alignItems:"center", justifyContent:"center" }}>
                  <ThumbsDown size={14} color="#ef4444"/>
                </div>
                <div>
                  <div style={{ fontSize:13, fontWeight:700, color:"#f87171" }}>Worst 10 Sewers - Most Rework</div>
                  <div style={{ fontSize:10, color:"#64748b" }}>Highest defective bags re-sewn</div>
                </div>
              </div>
              <ResponsiveContainer width="100%" height={280}>
                <ComposedChart data={worstSewers} layout="vertical" margin={{ top:4, right:54, left:8, bottom:0 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" horizontal={false}/>
                  <XAxis type="number" tick={{ fill:"#64748b", fontSize:10 }} tickLine={false}/>
                  <YAxis type="category" dataKey="id" tick={{ fill:"#94a3b8", fontSize:11 }} tickLine={false} width={52}/>
                  <Tooltip content={<Tip/>}/>
                  <Bar dataKey="total" name="Re-sewn Bags" radius={[0,6,6,0]}>
                    {worstSewers.map((_,i)=>(
                      <Cell key={i} fill={i===0?"#ef4444":i<3?"#f97316":"#f59e0b"}/>
                    ))}
                  </Bar>
                </ComposedChart>
              </ResponsiveContainer>
              <div style={{ display:"flex", gap:12, marginTop:8, fontSize:11, color:"#94a3b8" }}>
                {[["#ef4444","#1 Sewer"],["#f97316","Top 3"],["#f59e0b","Others"]].map(([c,l])=>(
                  <span key={l} style={{ display:"flex", alignItems:"center", gap:4 }}>
                    <span style={{ width:9, height:9, background:c, borderRadius:2, display:"inline-block" }}/>{l}
                  </span>
                ))}
              </div>
            </div>

            {/* BEST SEWERS */}
            <div style={{ background:"#0f172a", border:"1px solid rgba(34,197,94,.25)", borderRadius:12, padding:14 }}>
              <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:12 }}>
                <div style={{ width:28, height:28, background:"rgba(34,197,94,.15)", borderRadius:8,
                  display:"flex", alignItems:"center", justifyContent:"center" }}>
                  <Star size={14} color="#22c55e"/>
                </div>
                <div>
                  <div style={{ fontSize:13, fontWeight:700, color:"#4ade80" }}>Best 10 Sewers - Least Rework</div>
                  <div style={{ fontSize:10, color:"#64748b" }}>Lowest defective bags (active sewers ? 20 bags)</div>
                </div>
              </div>
              <ResponsiveContainer width="100%" height={280}>
                <ComposedChart data={bestSewers} layout="vertical" margin={{ top:4, right:54, left:8, bottom:0 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" horizontal={false}/>
                  <XAxis type="number" tick={{ fill:"#64748b", fontSize:10 }} tickLine={false}/>
                  <YAxis type="category" dataKey="id" tick={{ fill:"#94a3b8", fontSize:11 }} tickLine={false} width={52}/>
                  <Tooltip content={<Tip/>}/>
                  <Bar dataKey="total" name="Re-sewn Bags" radius={[0,6,6,0]}>
                    {bestSewers.map((_,i)=>(
                      <Cell key={i} fill={i===0?"#22c55e":i<3?"#10b981":"#14b8a6"}/>
                    ))}
                  </Bar>
                </ComposedChart>
              </ResponsiveContainer>
              <div style={{ display:"flex", gap:12, marginTop:8, fontSize:11, color:"#94a3b8" }}>
                {[["#22c55e","#1 Best"],["#10b981","Top 3"],["#14b8a6","Others"]].map(([c,l])=>(
                  <span key={l} style={{ display:"flex", alignItems:"center", gap:4 }}>
                    <span style={{ width:9, height:9, background:c, borderRadius:2, display:"inline-block" }}/>{l}
                  </span>
                ))}
              </div>
            </div>
          </div>

          {/* FULL SEWER TABLE */}
          <div style={{ marginTop:16, background:"#030712", borderRadius:12, overflow:"hidden" }}>
            <div style={{ padding:"10px 14px", borderBottom:"1px solid #1e293b",
              display:"flex", justifyContent:"space-between", alignItems:"center" }}>
              <span style={{ fontSize:13, fontWeight:600, color:"#f1f5f9" }}>All Sewers - Full Ranking</span>
              <span style={{ fontSize:11, color:"#64748b" }}>{sewerData.filter(s=>s.total>0).length} sewers - sorted by total</span>
            </div>
            <div style={{ overflowX:"auto", maxHeight:320, overflowY:"auto" }}>
              <table style={{ width:"100%", borderCollapse:"collapse", fontSize:11 }}>
                <thead style={{ position:"sticky", top:0 }}>
                  <tr>
                    {["#","Sewer ID","Role","Top Repaired","Bottom Repaired","Total"].map((h,i)=>(
                      <th key={h} style={{ padding:"8px 12px", textAlign:i<=2?"left":"right",
                        color:"#64748b", fontWeight:600, borderBottom:"1px solid #1e293b",
                        background:"#0a0f1e", whiteSpace:"nowrap" }}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {sewerData.filter(s=>s.total>0).map((s,i)=>{
                    const rb = roleBadge(s);
                    const pct = grandTotal > 0 ? ((s.total/grandTotal)*100).toFixed(1) : 0;
                    return (
                      <tr key={s.id} style={{ borderBottom:"1px solid rgba(30,41,59,.5)",
                        background: i===0?"rgba(239,68,68,.06)":i<3?"rgba(249,115,22,.04)":"transparent" }}>
                        <td style={{ padding:"7px 12px", color:"#475569", fontWeight:600 }}>{i+1}</td>
                        <td style={{ padding:"7px 12px" }}>
                          <span style={{ fontWeight:700, color:"#f1f5f9", fontSize:12 }}>{s.id}</span>
                          {i===0 && <span style={{ marginLeft:6, fontSize:10, background:"rgba(239,68,68,.2)", color:"#f87171", padding:"1px 5px", borderRadius:4 }}>Worst</span>}
                          {i===sewerData.filter(x=>x.total>0).length-1 && <span style={{ marginLeft:6, fontSize:10, background:"rgba(34,197,94,.15)", color:"#4ade80", padding:"1px 5px", borderRadius:4 }}>Best</span>}
                        </td>
                        <td style={{ padding:"7px 12px" }}>
                          <span style={{ fontSize:10, background:`${rb.color}22`, color:rb.color,
                            padding:"2px 7px", borderRadius:999, fontWeight:600 }}>{rb.label}</span>
                        </td>
                        <td style={{ padding:"7px 12px", textAlign:"right", color:C_DAY }}>{s.top||"-"}</td>
                        <td style={{ padding:"7px 12px", textAlign:"right", color:C_NIGHT }}>{s.bottom||"-"}</td>
                        <td style={{ padding:"7px 12px", textAlign:"right" }}>
                          <div style={{ display:"flex", alignItems:"center", justifyContent:"flex-end", gap:8 }}>
                            <div style={{ width:60, background:"#1e293b", borderRadius:999, height:5, overflow:"hidden" }}>
                              <div style={{ height:"100%", width:`${(s.total/(sewerData[0]?.total||1))*100}%`,
                                background: i===0?"#ef4444":i<3?"#f97316":"#3b82f6", borderRadius:999 }}/>
                            </div>
                            <span style={{ fontWeight:700, color:"#f1f5f9", minWidth:28, textAlign:"right" }}>{s.total}</span>
                            <span style={{ fontSize:10, color:"#475569", minWidth:36 }}>{pct}%</span>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        {/* MACHINES + LINES */}
        <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(340px,1fr))", gap:16 }}>
          <div style={S.card}>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:14 }}>
              <div><div style={S.title}>Top 10 Machines</div><div style={S.sub}>Re-sewn bags per machine</div></div>
              <Cpu size={18} color="#a78bfa"/>
            </div>
            <ResponsiveContainer width="100%" height={260}>
              <ComposedChart data={machineData} layout="vertical" margin={{ top:4, right:50, left:10, bottom:0 }}>
                <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" horizontal={false}/>
                <XAxis type="number" tick={{ fill:"#64748b", fontSize:10 }} tickLine={false}/>
                <YAxis type="category" dataKey="machine" tick={{ fill:"#94a3b8", fontSize:11 }} tickLine={false} width={52}/>
                <Tooltip content={<Tip/>}/>
                <Bar dataKey="rework" name="Re-sewn Bags" radius={[0,6,6,0]}>
                  {machineData.map((_,i)=><Cell key={i} fill={i===0?"#ef4444":i<3?"#f59e0b":"#3b82f6"}/>)}
                </Bar>
              </ComposedChart>
            </ResponsiveContainer>
          </div>
          <div style={S.card}>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:14 }}>
              <div><div style={S.title}>Rework by Production Line</div><div style={S.sub}>{lineData.length} lines</div></div>
              <LayoutGrid size={18} color="#10B981"/>
            </div>
            <ResponsiveContainer width="100%" height={260}>
              <ComposedChart data={lineData} layout="vertical" margin={{ top:4, right:50, left:10, bottom:0 }}>
                <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" horizontal={false}/>
                <XAxis type="number" tick={{ fill:"#64748b", fontSize:10 }} tickLine={false}/>
                <YAxis type="category" dataKey="line" tick={{ fill:"#94a3b8", fontSize:11 }} tickLine={false} width={52}/>
                <Tooltip content={<Tip/>}/>
                <Bar dataKey="rework" name="Re-sewn Bags" radius={[0,6,6,0]}>
                  {lineData.map((_,i)=><Cell key={i} fill={LINE_COLORS[i%LINE_COLORS.length]}/>)}
                </Bar>
              </ComposedChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* DAY vs NIGHT COMPARISON */}
        <div style={S.card}>
          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:14 }}>
            <div><div style={S.title}>Day vs Night - Daily Comparison</div>
              <div style={S.sub}>Side-by-side shift rework count each day</div></div>
            <Activity size={18} color="#60a5fa"/>
          </div>
          <ResponsiveContainer width="100%" height={220}>
            <ComposedChart data={dailyData} margin={{ top:4, right:4, left:-14, bottom:0 }}
              onClick={e => e?.activeTooltipIndex != null && setSelIdx(e.activeTooltipIndex)}>
              <CartesianGrid strokeDasharray="3 3" stroke="#1e293b"/>
              <XAxis dataKey="date" tick={{ fill:"#64748b", fontSize:10 }} tickLine={false}
                interval={Math.max(0,Math.floor(dailyData.length/10)-1)}/>
              <YAxis tick={{ fill:"#64748b", fontSize:10 }} tickLine={false}/>
              <Tooltip content={<Tip/>}/>
              <Legend wrapperStyle={{ fontSize:12, color:"#94a3b8" }}/>
              <Bar dataKey="shiftDay"   name="Day Shift"   fill={C_DAY}   radius={[3,3,0,0]} barSize={10} style={{ cursor:"pointer" }}/>
              <Bar dataKey="shiftNight" name="Night Shift" fill={C_NIGHT} radius={[3,3,0,0]} barSize={10} style={{ cursor:"pointer" }}/>
              <ReferenceLine x={selectedDay.date} stroke="#60a5fa" strokeWidth={2} strokeDasharray="4 2"/>
            </ComposedChart>
          </ResponsiveContainer>
        </div>

        {/* DATA TABLE */}
        <div style={{ background:"#0f172a", border:"1px solid #1e293b", borderRadius:16, overflow:"hidden" }}>
          <div style={{ padding:"14px 16px", borderBottom:"1px solid #1e293b",
            display:"flex", justifyContent:"space-between", alignItems:"center" }}>
            <div>
              <div style={S.title}>Daily Data Table</div>
              <div style={S.sub}>{period} - {dailyData.length} days - selected: <b style={{color:"#60a5fa"}}>{selectedDay.date}</b> - {fileName||"Re-sewn Bags February 2026.xlsx"}</div>
            </div>
            <FileText size={16} color="#64748b"/>
          </div>
          <div style={{ overflowX:"auto" }}>
            <table style={{ width:"100%", borderCollapse:"collapse", fontSize:12 }}>
              <thead>
                <tr>
                  {["Date","Day Shift","Night Shift","Total","vs Avg"].map((h,i)=>(
                    <th key={h} style={{ padding:"10px 16px", textAlign:i===0?"left":"right",
                      color:"#64748b", fontSize:11, fontWeight:600, borderBottom:"1px solid #1e293b", whiteSpace:"nowrap" }}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {dailyData.map((row,i)=>{
                  const avg = parseFloat(avgDaily);
                  const diff = row.total - avg;
                  const isSelected = i === clampedIdx;
                  return (
                    <tr key={i}
                      onClick={() => setSelIdx(i)}
                      style={{ borderBottom:"1px solid rgba(30,41,59,.5)",
                        background: isSelected
                          ? "rgba(59,130,246,.15)"
                          : i%2===0?"transparent":"rgba(30,41,59,.22)",
                        outline: isSelected ? "1px solid rgba(59,130,246,.4)" : "none",
                        cursor:"pointer",
                        transition:"background .15s" }}>
                      <td style={{ padding:"8px 16px", color: isSelected?"#93c5fd":"#cbd5e1", fontWeight: isSelected?700:500 }}>
                        {isSelected && <span style={{ color:"#60a5fa", marginRight:5, fontSize:10 }}>></span>}
                        {row.date}
                      </td>
                      <td style={{ padding:"8px 16px", textAlign:"right", color:C_DAY }}>{row.shiftDay}</td>
                      <td style={{ padding:"8px 16px", textAlign:"right", color:C_NIGHT }}>{row.shiftNight}</td>
                      <td style={{ padding:"8px 16px", textAlign:"right", color:"#f1f5f9", fontWeight:700 }}>{row.total}</td>
                      <td style={{ padding:"8px 16px", textAlign:"right" }}>
                        <span style={{ fontSize:11, fontWeight:600,
                          color:diff>10?"#34d399":diff<-10?"#f87171":"#94a3b8" }}>
                          {diff>0?"+":""}{diff.toFixed(0)}
                        </span>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
              <tfoot>
                <tr style={{ background:"#1e293b" }}>
                  <td style={{ padding:"10px 16px", fontWeight:700, color:"#f1f5f9" }}>TOTAL</td>
                  <td style={{ padding:"10px 16px", textAlign:"right", color:C_DAY, fontWeight:700 }}>{totalDay.toLocaleString()}</td>
                  <td style={{ padding:"10px 16px", textAlign:"right", color:C_NIGHT, fontWeight:700 }}>{totalNight.toLocaleString()}</td>
                  <td style={{ padding:"10px 16px", textAlign:"right", color:"#f1f5f9", fontWeight:800 }}>{grandTotal.toLocaleString()}</td>
                  <td style={{ padding:"10px 16px", textAlign:"right", color:"#64748b", fontSize:11 }}>avg {avgDaily}/day</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div style={{ textAlign:"center", fontSize:11, color:"#1e293b", paddingBottom:8 }}>
          Re-sewn Bags Dashboard - {period} - {fileName||"Re-sewn Bags February 2026.xlsx"} - Confidential
        </div>
      </main>
    </div>
  );
}


// --- Mount --------------------------------------------------------------------
const _root = ReactDOM.createRoot(document.getElementById('root'));
_root.render(<Dashboard/>);
document.getElementById('loading-screen').style.display = 'none';



// --- Mount --------------------------------------------------------------------
const _root = ReactDOM.createRoot(document.getElementById('root'));
_root.render(<Dashboard/>);
document.getElementById('loading-screen').style.display = 'none';


  </script>
</body>
</html>
